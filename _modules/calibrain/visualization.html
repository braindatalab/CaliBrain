
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>calibrain.visualization &#8212; CaliBrain Documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-binder.css?v=f4aeca0c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=38cd5f79" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=b14783f5"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/calibrain/visualization';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = '_static/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'v0.1.2';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            true;
        </script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">ðŸ“š You are viewing CaliBrain v0.1.2 documentation</div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/caliBrain.png" class="logo__image only-light" alt=""/>
    <img src="../../_static/caliBrain.png" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">CaliBrain</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../installation/README.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../documentation/README.html">
    Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../development/README.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/README.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
        </div>
      
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/braindatalab/CaliBrain" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../installation/README.html">
    Installation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../documentation/README.html">
    Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../development/README.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/README.html">
    API Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/braindatalab/CaliBrain" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fab fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">calibrain.visualization</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for calibrain.visualization</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">cm</span><span class="p">,</span> <span class="n">gridspec</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">mne</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mne.io.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">FIFF</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.lines</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mlines</span> <span class="c1"># For creating custom legend handles</span>

<div class="viewcode-block" id="Visualizer">
<a class="viewcode-back" href="../../api/visualization/Visualizer.html#calibrain.visualization.Visualizer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Visualizer</span><span class="p">:</span>
<div class="viewcode-block" id="Visualizer.__init__">
<a class="viewcode-back" href="../../api/visualization/Visualizer.html#calibrain.visualization.Visualizer.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;results/figures&quot;</span><span class="p">,</span> <span class="n">logger</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">logging</span><span class="o">.</span><span class="n">Logger</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_save_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">base_save_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logger</span> <span class="ow">or</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_handle_figure_output</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">fig</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">save_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">save_path</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_save_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">save_dir</span><span class="o">.</span><span class="n">is_absolute</span><span class="p">():</span>
            <span class="n">save_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_save_path</span> <span class="o">/</span> <span class="n">save_dir</span>
        <span class="n">save_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;.png&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;.jpeg&#39;</span><span class="p">]:</span>
            <span class="n">file_name</span> <span class="o">+=</span> <span class="s2">&quot;.png&quot;</span>

        <span class="n">full_path</span> <span class="o">=</span> <span class="n">save_dir</span> <span class="o">/</span> <span class="n">file_name</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Figure saved to </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="c1"># Don&#39;t close the figure immediately if show=True to allow Sphinx Gallery to capture it</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">show</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

    <span class="c1"># --------------------------------------------</span>
    <span class="c1"># --- Vizualisation for source and sensor data</span>
    <span class="c1"># --------------------------------------------</span>
    <span class="c1"># --- plot sources</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_sources_single_trial</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ERP_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">x_trial</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">active_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
        <span class="n">units</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">trial_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
        <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_plot_params</span><span class="p">(</span><span class="n">ERP_config</span><span class="p">,</span> <span class="n">x_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">x_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x_trial</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">x_trial</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">x_trial</span>
        <span class="k">if</span> <span class="n">active_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">active_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_plot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_indices</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">src_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">active_indices</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">x_plot</span><span class="p">[</span><span class="n">src_idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Source </span><span class="si">{</span><span class="n">src_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">stim_onset</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stimulus Onset&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tmax</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">tmin</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">tmax</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="p">[</span><span class="n">tmin</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">tmax</span><span class="p">]])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Amplitude (</span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2"> (Trial </span><span class="si">{</span><span class="n">trial_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_sources_all_trials</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ERP_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">x_trials</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">active_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">units</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Source Signals&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
        <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_plot_params</span><span class="p">(</span><span class="n">ERP_config</span><span class="p">,</span> <span class="n">x_trials</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>        
        <span class="n">n_trials</span> <span class="o">=</span> <span class="n">x_trials</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_trials</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_trials</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">x_trial</span> <span class="o">=</span> <span class="n">x_trials</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">x_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x_trial</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">x_trial</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">x_trial</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="n">active_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="n">active_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_plot</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">src_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">x_plot</span><span class="p">[</span><span class="n">src_idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Source </span><span class="si">{</span><span class="n">src_idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">stim_onset</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stimulus Onset&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tmax</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Amplitude (</span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2"> â€” Trial </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">tmin</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">tmax</span><span class="p">])</span>
        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tick</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span> <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="p">[</span><span class="n">tmin</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">tmax</span><span class="p">]])</span>
        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span>
    
<div class="viewcode-block" id="Visualizer.plot_source_signals">
<a class="viewcode-back" href="../../api/visualization/Visualizer.html#calibrain.visualization.Visualizer.plot_source_signals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_source_signals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ERP_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">x_trials</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">x_active_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">units</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">trial_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Source Signals&quot;</span><span class="p">,</span>
        <span class="n">save_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># convert the data from A to nAm for better readability</span>
        <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_AM</span><span class="p">:</span>
            <span class="n">x_scaled</span> <span class="o">=</span> <span class="n">x_trials</span> <span class="o">*</span> <span class="mf">1e9</span>  
            <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;nAm&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported units for source signals: </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2">. Expected FIFF.FIFF_UNIT_AM.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trial_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">indices</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">x_active_indices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">x_active_indices</span><span class="p">[</span><span class="n">trial_idx</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_active_indices</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="k">else</span> <span class="n">x_active_indices</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_sources_single_trial</span><span class="p">(</span>
                <span class="n">ERP_config</span><span class="o">=</span><span class="n">ERP_config</span><span class="p">,</span>
                <span class="n">x_trial</span><span class="o">=</span><span class="n">x_scaled</span> <span class="k">if</span> <span class="n">x_scaled</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">x_scaled</span><span class="p">[</span><span class="n">trial_idx</span><span class="p">],</span>
                <span class="n">active_indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
                <span class="n">trial_idx</span><span class="o">=</span><span class="n">trial_idx</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;source_signals_trial_</span><span class="si">{</span><span class="n">trial_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_sources_all_trials</span><span class="p">(</span>
                <span class="n">ERP_config</span><span class="o">=</span><span class="n">ERP_config</span><span class="p">,</span>
                <span class="n">x_trials</span><span class="o">=</span><span class="n">x_scaled</span><span class="p">,</span>
                <span class="n">active_indices</span><span class="o">=</span><span class="n">x_active_indices</span><span class="p">,</span>
                <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span> <span class="ow">or</span> <span class="s2">&quot;source_signals_all_trials&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_figure_output</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">show</span><span class="p">)</span></div>


    <span class="c1"># --- plot sensors        </span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_sensors_single_trial</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ERP_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">trial_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">channels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">]],</span>
        <span class="n">units</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">save_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">):</span>
        <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">times</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_plot_params</span><span class="p">(</span><span class="n">ERP_config</span><span class="p">,</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">channels_to_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_channels</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">channels</span><span class="p">)</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plot_sensors</span><span class="p">(</span>
            <span class="n">ax</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">channels_to_plot</span><span class="p">],</span> <span class="n">times</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">channels_to_plot</span><span class="p">,</span> <span class="n">units</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2"> (Trial </span><span class="si">{</span><span class="n">trial_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_figure_output</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_trial_</span><span class="si">{</span><span class="n">trial_idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">show</span><span class="p">)</span>
        
    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_sensors_all_trials</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ERP_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">y_trials</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">channels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">]],</span>
        <span class="n">units</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">save_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">):</span>
        <span class="n">n_trials</span> <span class="o">=</span> <span class="n">y_trials</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_plot_params</span><span class="p">(</span><span class="n">ERP_config</span><span class="p">,</span> <span class="n">y_trials</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">channels_to_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_channels</span><span class="p">(</span><span class="n">y_trials</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">channels</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">n_trials</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_trials</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_trials</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_sensors</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">y_trials</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">channels_to_plot</span><span class="p">],</span> <span class="n">times</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">channels_to_plot</span><span class="p">,</span> <span class="n">units</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trial </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_figure_output</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_all_trials&quot;</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">show</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_concatenated_sensor_trials</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">y_trials</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">ERP_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">channels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">]],</span>
        <span class="n">units</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">save_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">):</span>
        <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">sfreq</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_plot_params</span><span class="p">(</span><span class="n">ERP_config</span><span class="p">,</span> <span class="n">y_trials</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">n_trials</span><span class="p">,</span> <span class="n">n_sensors</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">y_trials</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">trial_duration</span> <span class="o">=</span> <span class="n">tmax</span> <span class="o">-</span> <span class="n">tmin</span>
        <span class="n">times_single</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sfreq</span><span class="p">)</span>
        <span class="n">channels_to_plot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_channels</span><span class="p">(</span><span class="n">n_sensors</span><span class="p">,</span> <span class="n">channels</span><span class="p">)</span>
        
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels_to_plot</span><span class="p">)))</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_trials</span><span class="p">):</span>
            <span class="n">trial_times</span> <span class="o">=</span> <span class="n">times_single</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">trial_duration</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channels_to_plot</span><span class="p">):</span>
                <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Ch </span><span class="si">{</span><span class="n">ch</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">trial_times</span><span class="p">,</span> <span class="n">y_trials</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">ch</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">trial_duration</span> <span class="o">+</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Amplitude (</span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_trials</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels_to_plot</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_figure_output</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">_concatenated&quot;</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">show</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_plot_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ERP_config</span><span class="p">,</span> <span class="n">n_times</span><span class="p">):</span>
        <span class="n">tmin</span> <span class="o">=</span> <span class="n">ERP_config</span><span class="p">[</span><span class="s1">&#39;tmin&#39;</span><span class="p">]</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">ERP_config</span><span class="p">[</span><span class="s1">&#39;tmax&#39;</span><span class="p">]</span>
        <span class="n">stim_onset</span> <span class="o">=</span> <span class="n">ERP_config</span><span class="p">[</span><span class="s1">&#39;stim_onset&#39;</span><span class="p">]</span>
        <span class="n">sfreq</span> <span class="o">=</span> <span class="n">ERP_config</span><span class="p">[</span><span class="s1">&#39;sfreq&#39;</span><span class="p">]</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">sfreq</span><span class="p">)[:</span><span class="n">n_times</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">sfreq</span><span class="p">,</span> <span class="n">times</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_sensors</span><span class="p">,</span> <span class="n">channels</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">channels</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_sensors</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_plot_sensors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tmin</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tmax</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">channels</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">units</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Ch </span><span class="si">{</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">stim_onset</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stimulus Onset&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tmin</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tmax</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">tmin</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">tmax</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmin</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stim_onset</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tmax</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Amplitude (</span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Visualizer.plot_sensor_signals">
<a class="viewcode-back" href="../../api/visualization/Visualizer.html#calibrain.visualization.Visualizer.plot_sensor_signals">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_sensor_signals</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ERP_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">y_trials</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">trial_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">channels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">units</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;stack&quot;</span><span class="p">,</span>  <span class="c1"># &quot;stack&quot; | &quot;concatenate&quot;</span>
        <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Sensor Signals&quot;</span><span class="p">,</span>
        <span class="n">save_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">ERP_config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ERP_config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;tmin&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="s2">&quot;tmax&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                <span class="s2">&quot;stim_onset&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;sfreq&quot;</span><span class="p">:</span> <span class="mi">250</span><span class="p">,</span>
                <span class="s2">&quot;fmin&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;fmax&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                <span class="s2">&quot;amplitude&quot;</span><span class="p">:</span> <span class="mf">20.0</span><span class="p">,</span>
                <span class="s2">&quot;random_erp_timing&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;erp_min_length&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># for better readability convert the data from T to fT for MEG magnetometers channels and T/m to fT/m for MEG gradiometers channels, and V to Î¼V for EEG channels</span>
        <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_T</span><span class="p">:</span>
            <span class="n">y_trials_scaled</span> <span class="o">=</span> <span class="n">y_trials</span> <span class="o">*</span> <span class="mf">1e15</span>  <span class="c1"># Convert Tesla to femtoTesla (fT)</span>
            <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;fT&quot;</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_T_M</span><span class="p">:</span>
            <span class="n">y_trials_scaled</span> <span class="o">=</span> <span class="n">y_trials</span> <span class="o">*</span> <span class="mf">1e15</span>  <span class="c1"># Convert T/m to fT/m</span>
            <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;fT/m&quot;</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_V</span><span class="p">:</span>
            <span class="n">y_trials_scaled</span> <span class="o">=</span> <span class="n">y_trials</span> <span class="o">*</span> <span class="mf">1e6</span>  <span class="c1"># Convert V to Î¼V</span>
            <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;Î¼V&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported units for sensor signals: </span><span class="si">{</span><span class="n">units</span><span class="si">}</span><span class="s2">. Expected FIFF.FIFF_UNIT_T, FIFF.FIFF_UNIT_T_M, or FIFF.FIFF_UNIT_V.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;stack&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_sensors_all_trials</span><span class="p">(</span>
                <span class="n">ERP_config</span><span class="p">,</span> <span class="n">y_trials_scaled</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">show</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;concatenate&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_concatenated_sensor_trials</span><span class="p">(</span>
                <span class="n">y_trials_scaled</span><span class="p">,</span> <span class="n">ERP_config</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">show</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;single&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trial_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">trial_idx</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No trial index provided, defaulting to 0.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plot_sensors_single_trial</span><span class="p">(</span>
                <span class="n">ERP_config</span><span class="p">,</span> <span class="n">y_trials_scaled</span><span class="p">[</span><span class="n">trial_idx</span><span class="p">],</span> <span class="n">trial_idx</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">save_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">show</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Visualizer.plot_stc_3d_brain">
<a class="viewcode-back" href="../../api/visualization/Visualizer.html#calibrain.visualization.Visualizer.plot_stc_3d_brain">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_stc_3d_brain</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ERP_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">x_one_trial</span><span class="p">,</span>
        <span class="n">x_hat_one_trial</span><span class="p">,</span>
        <span class="n">orientations</span><span class="p">,</span>
        <span class="n">source_units</span><span class="p">,</span>
        <span class="n">sample_idx</span><span class="p">,</span>
        <span class="n">subject</span><span class="p">,</span>
        <span class="n">subjects_dir</span><span class="p">,</span>
        <span class="n">fwd_path</span><span class="p">,</span>
        <span class="n">save_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot source estimates with complete headless support.&quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">show</span><span class="p">:</span>
            <span class="c1"># Skip 3D visualization entirely for headless mode</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping 3D brain visualization (show=False)&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="c1"># Only do 3D plotting when show=True</span>
        <span class="n">original_backend</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">get_3d_backend</span><span class="p">()</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">set_3d_backend</span><span class="p">(</span><span class="s1">&#39;pyvistaqt&#39;</span><span class="p">)</span>
            
            <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">sfreq</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_plot_params</span><span class="p">(</span><span class="n">ERP_config</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="c1"># Load forward solution</span>
            <span class="n">fwd</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">read_forward_solution</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fwd_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">-fwd.fif&quot;</span><span class="p">)</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="p">[</span><span class="n">src_hemi</span><span class="p">[</span><span class="s1">&#39;vertno&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">src_hemi</span> <span class="ow">in</span> <span class="n">fwd</span><span class="p">[</span><span class="s1">&#39;src&#39;</span><span class="p">]]</span>
            
            <span class="c1"># Create source estimates</span>
            <span class="n">stc_x_t0</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">SourceEstimate</span><span class="p">(</span><span class="n">x_one_trial</span><span class="p">[:,</span> <span class="n">sample_idx</span><span class="p">],</span> <span class="n">vertices</span><span class="o">=</span><span class="n">vertices</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tstep</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">sfreq</span><span class="p">)</span>
            <span class="n">stc_x_hat_t0</span> <span class="o">=</span> <span class="n">mne</span><span class="o">.</span><span class="n">SourceEstimate</span><span class="p">(</span><span class="n">x_hat_one_trial</span><span class="p">[:,</span> <span class="n">sample_idx</span><span class="p">],</span> <span class="n">vertices</span><span class="o">=</span><span class="n">vertices</span><span class="p">,</span> <span class="n">tmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tstep</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="n">sfreq</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">source_units</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_AM</span><span class="p">:</span>
                <span class="n">x_scaled</span> <span class="o">=</span> <span class="n">stc_x_t0</span> <span class="o">*</span> <span class="mf">1e9</span>  
                <span class="n">x_hat_scaled</span> <span class="o">=</span> <span class="n">stc_x_hat_t0</span> <span class="o">*</span> <span class="mf">1e9</span>  
                <span class="n">source_units</span> <span class="o">=</span> <span class="s2">&quot;nAm&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported units for source signals: </span><span class="si">{</span><span class="n">source_units</span><span class="si">}</span><span class="s2">. Expected FIFF.FIFF_UNIT_AM.&quot;</span><span class="p">)</span>

            <span class="n">source_estimates</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">x_scaled</span><span class="p">,</span> <span class="s1">&#39;Ground Truth&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="n">x_hat_scaled</span><span class="p">,</span> <span class="s1">&#39;Posterior Mean&#39;</span><span class="p">),</span>
            <span class="p">]</span>
            
            <span class="k">for</span> <span class="n">stc</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">source_estimates</span><span class="p">:</span>
                <span class="n">brain</span> <span class="o">=</span> <span class="n">stc</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">hemi</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span>
                    <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
                    <span class="n">subjects_dir</span><span class="o">=</span><span class="n">subjects_dir</span><span class="p">,</span>
                    <span class="n">spacing</span><span class="o">=</span><span class="s1">&#39;ico4&#39;</span><span class="p">,</span>
                    <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                    <span class="n">time_viewer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Can be True since show=True</span>
                    <span class="n">views</span><span class="o">=</span><span class="n">orientations</span><span class="p">,</span>
                <span class="p">)</span>
                
                <span class="k">if</span> <span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">brain_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">brain_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="n">file_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">title</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">.png&quot;</span>
                    <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">brain_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
                    <span class="n">brain</span><span class="o">.</span><span class="n">save_image</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Brain plot saved to </span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="n">brain</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in 3D visualization: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mne</span><span class="o">.</span><span class="n">viz</span><span class="o">.</span><span class="n">set_3d_backend</span><span class="p">(</span><span class="n">original_backend</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span></div>


<div class="viewcode-block" id="Visualizer.plot_source_and_sensors">
<a class="viewcode-back" href="../../api/visualization/Visualizer.html#calibrain.visualization.Visualizer.plot_source_and_sensors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_source_and_sensors</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_one_trial</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">x_active_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_clean_one_trial</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_noisy_one_trial</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">nnz</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">ERP_config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">source_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_AM</span><span class="p">,</span>
        <span class="n">sensor_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_V</span><span class="p">,</span>
        <span class="n">orientation_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fixed&quot;</span><span class="p">,</span>
        <span class="n">max_sensors</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
        <span class="n">plot_sensors_together</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">shift</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20.0</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;data_simulation.png&#39;</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;results/figures/data_sim.png&#39;</span><span class="p">,</span>
        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualize source activity and sensor measurements.</span>

<span class="sd">        Plots active source time courses and compares clean vs. noisy sensor signals.</span>
<span class="sd">        Includes a line indicating stimulus onset.</span>
<span class="sd">        Uses self.tmin and self.tmax for the time axis.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : np.ndarray</span>
<span class="sd">            Source activity. Shape depends on orientation type.</span>
<span class="sd">        y_clean : np.ndarray</span>
<span class="sd">            Clean sensor measurements (n_sensors, n_times).</span>
<span class="sd">        y_noisy : np.ndarray</span>
<span class="sd">            Noisy sensor measurements (n_sensors, n_times).</span>
<span class="sd">        active_sources : Optional[np.ndarray], optional</span>
<span class="sd">            Indices of non-zero (active) sources. If None, they are determined from x, by default None.</span>
<span class="sd">        nnz_to_plot : int, optional</span>
<span class="sd">            Number of non-zero sources to plot. If -1, plot all non-zero sources found, by default -1.</span>
<span class="sd">        sfreq : float, optional</span>
<span class="sd">            Sampling frequency in Hz, by default self.sfreq.</span>
<span class="sd">        max_sensors : int, optional</span>
<span class="sd">            Maximum number of sensors to plot, by default 3.</span>
<span class="sd">        plot_sensors_together : bool, optional</span>
<span class="sd">            If True, plot all sensors on the same subplot. If False, stack plots vertically, by default False.</span>
<span class="sd">        shift : float, optional</span>
<span class="sd">            Vertical shift between sensors when plotting together, by default 20.0.</span>
<span class="sd">        figsize : Tuple[float, float], optional</span>
<span class="sd">            Figure size for the plot, by default (14, 10).</span>
<span class="sd">        save_path : Optional[str], optional</span>
<span class="sd">            Path to save the figure. If None, the figure is not saved, by default &#39;results/figures/data_sim.png&#39;.</span>
<span class="sd">        show : bool, optional</span>
<span class="sd">            If True, display the plot, by default False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Use self.sfreq if the passed sfreq is the default placeholder, otherwise use passed sfreq</span>
        
        <span class="k">if</span> <span class="n">sensor_units</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_T</span><span class="p">:</span>
            <span class="n">y_clean_scaled</span> <span class="o">=</span> <span class="n">y_clean_one_trial</span> <span class="o">*</span> <span class="mf">1e15</span>  <span class="c1"># Convert Tesla to femtoTesla (fT)</span>
            <span class="n">y_noisy_scaled</span> <span class="o">=</span> <span class="n">y_noisy_one_trial</span> <span class="o">*</span> <span class="mf">1e15</span>  <span class="c1"># Convert Tesla to femtoTesla (fT)</span>
            <span class="n">sensor_units</span> <span class="o">=</span> <span class="s2">&quot;fT&quot;</span>
        <span class="k">elif</span> <span class="n">sensor_units</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_T_M</span><span class="p">:</span>
            <span class="n">y_clean_scaled</span> <span class="o">=</span> <span class="n">y_clean_one_trial</span> <span class="o">*</span> <span class="mf">1e15</span>  <span class="c1"># Convert T/m to fT/m</span>
            <span class="n">y_noisy_scaled</span> <span class="o">=</span> <span class="n">y_noisy_one_trial</span> <span class="o">*</span> <span class="mf">1e15</span>  <span class="c1"># Convert T/m to fT/m</span>
            <span class="n">sensor_units</span> <span class="o">=</span> <span class="s2">&quot;fT/m&quot;</span>
        <span class="k">elif</span> <span class="n">sensor_units</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_V</span><span class="p">:</span>
            <span class="n">y_clean_scaled</span> <span class="o">=</span> <span class="n">y_clean_one_trial</span> <span class="o">*</span> <span class="mf">1e6</span>  <span class="c1"># Convert V to Î¼V</span>
            <span class="n">y_noisy_scaled</span> <span class="o">=</span> <span class="n">y_noisy_one_trial</span> <span class="o">*</span> <span class="mf">1e6</span>  <span class="c1"># Convert V to Î¼V</span>
            <span class="n">sensor_units</span> <span class="o">=</span> <span class="s2">&quot;Î¼V&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported units for sensor signals: </span><span class="si">{</span><span class="n">sensor_units</span><span class="si">}</span><span class="s2">. Expected FIFF.FIFF_UNIT_T, FIFF.FIFF_UNIT_T_M, or FIFF.FIFF_UNIT_V.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">source_units</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_AM</span><span class="p">:</span>
            <span class="n">x_scaled</span> <span class="o">=</span> <span class="n">x_one_trial</span> <span class="o">*</span> <span class="mf">1e9</span>  <span class="c1"># Convert A/m to nAm</span>
            <span class="n">source_units</span> <span class="o">=</span> <span class="s2">&quot;nAm&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported units for source activity: </span><span class="si">{</span><span class="n">source_units</span><span class="si">}</span><span class="s2">. Expected FIFF.FIFF_UNIT_AM.&quot;</span><span class="p">)</span>

        <span class="n">n_times_from_data</span> <span class="o">=</span> <span class="n">y_clean_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tmin</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">stim_onset</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_plot_params</span><span class="p">(</span><span class="n">ERP_config</span><span class="p">,</span> <span class="n">x_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">y_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_clean_scaled</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_noisy_scaled</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_clean_scaled</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">y_noisy_scaled</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">y_range</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span> <span class="k">if</span> <span class="n">y_max</span> <span class="o">&gt;</span> <span class="n">y_min</span> <span class="k">else</span> <span class="mf">1.0</span>

        <span class="n">num_sensors_to_plot</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_sensors</span><span class="p">,</span> <span class="n">y_clean_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">total_plots</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">plot_sensors_together</span> <span class="k">else</span> <span class="n">num_sensors_to_plot</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">total_plots</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
            <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;height_ratios&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">total_plots</span><span class="p">},</span> 
            <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">total_plots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span>

        <span class="n">ax_sources</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">orientation_type</span> <span class="o">==</span> <span class="s2">&quot;fixed&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_active_indices</span><span class="p">:</span>
                <span class="n">ax_sources</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">x_scaled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Source </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">orientation_type</span> <span class="o">==</span> <span class="s2">&quot;free&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_active_indices</span><span class="p">:</span>
                <span class="n">source_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x_scaled</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">ax_sources</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">source_norm</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Source </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> (Norm)&quot;</span><span class="p">)</span>

        <span class="n">ax_sources</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">stim_onset</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Stimulus Onset&#39;</span><span class="p">)</span>
        <span class="n">ax_sources</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">nnz</span><span class="si">}</span><span class="s2"> Active Simulated Source Activity&quot;</span><span class="p">)</span>
        <span class="n">ax_sources</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Amplitude (</span><span class="si">{</span><span class="n">source_units</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">ax_sources</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax_sources</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

        <span class="n">sensor_axes</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">plot_sensors_together</span><span class="p">:</span>
            <span class="n">ax_sensors</span> <span class="o">=</span> <span class="n">sensor_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">current_shift</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sensors_to_plot</span><span class="p">):</span>
                <span class="n">ax_sensors</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">y_clean_scaled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">current_shift</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Clean (Sensor </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                <span class="n">ax_sensors</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">y_noisy_scaled</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">current_shift</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Noisy (Sensor </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                <span class="n">current_shift</span> <span class="o">+=</span> <span class="n">shift</span>
            <span class="n">ax_sensors</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">stim_onset</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Stimulus Onset&#39;</span><span class="p">)</span>
            <span class="n">ax_sensors</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Sensor Measurements&quot;</span><span class="p">)</span>
            <span class="n">ax_sensors</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Amplitude (</span><span class="si">{</span><span class="n">sensor_units</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span> 
            <span class="n">ax_sensors</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Consolidate legend for &quot;Stimulus Onset&quot; if it&#39;s plotted multiple times</span>
            <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax_sensors</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span> <span class="c1"># Remove duplicate labels</span>
            <span class="n">ax_sensors</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ax_sens</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sensor_axes</span><span class="p">):</span>
                <span class="n">ax_sens</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">y_clean_scaled</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Clean&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                <span class="n">ax_sens</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">y_noisy_scaled</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Noisy&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax_sens</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">stim_onset</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Stimulus Onset&#39;</span><span class="p">)</span>
                <span class="n">ax_sens</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sensor </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ax_sens</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Amplitude (</span><span class="si">{</span><span class="n">sensor_units</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">ax_sens</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_min</span> <span class="o">-</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">y_range</span><span class="p">)</span> 
                <span class="n">ax_sens</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax_sens</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
                <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
                <span class="n">ax_sens</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>

        <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_figure_output</span><span class="p">(</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">show</span><span class="p">)</span></div>


    <span class="c1"># -------------------------------------------</span>
    <span class="c1"># --- Visualization for Uncertainty</span>
    <span class="c1"># -------------------------------------------</span>

<div class="viewcode-block" id="Visualizer.plot_active_sources">
<a class="viewcode-back" href="../../api/visualization/Visualizer.html#calibrain.visualization.Visualizer.plot_active_sources">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_active_sources</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_one_trial_one_time</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">x_hat_one_trial_one_time</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">x_active_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">x_hat_active_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">n_sources</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">source_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_AM</span><span class="p">,</span>
        <span class="n">orientation_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fixed&quot;</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the active sources at a specific time step, or averaged across time, comparing ground truth and estimated values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : np.ndarray</span>
<span class="sd">            Ground truth values for components specified by active_indices.</span>
<span class="sd">        x_hat : np.ndarray</span>
<span class="sd">            Estimated values for components specified by active_indices.</span>
<span class="sd">        x_active_indices : np.ndarray</span>
<span class="sd">            Indices of active sources in the ground truth.</span>
<span class="sd">        x_hat_active_indices : np.ndarray</span>
<span class="sd">            Indices of active sources in the estimated values.</span>
<span class="sd">        n_sources : int</span>
<span class="sd">            Total number of sources.</span>
<span class="sd">        source_units : str, optional</span>
<span class="sd">            Units for the source signals, by default FIFF.FIFF_UNIT_AM</span>
<span class="sd">        orientation_type : str, optional</span>
<span class="sd">            Orientation type for the plot, by default &quot;fixed&quot;</span>
<span class="sd">        save_path : Optional[str], optional</span>
<span class="sd">            Path to save the plot, by default None</span>
<span class="sd">        file_name : Optional[str], optional</span>
<span class="sd">            Name of the file to save the plot, by default None</span>
<span class="sd">        title : Optional[str], optional</span>
<span class="sd">            Title of the plot, by default None</span>
<span class="sd">        show : bool, optional</span>
<span class="sd">            Whether to show the plot, by default True</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="c1"># convert the data from A to nAm for better readability</span>
        <span class="k">if</span> <span class="n">source_units</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_AM</span><span class="p">:</span>
            <span class="n">x_active_scaled</span> <span class="o">=</span> <span class="n">x_one_trial_one_time</span><span class="p">[</span><span class="n">x_active_indices</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">x_hat_active_scaled</span> <span class="o">=</span> <span class="n">x_hat_one_trial_one_time</span><span class="p">[</span><span class="n">x_hat_active_indices</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">source_units</span> <span class="o">=</span> <span class="s2">&quot;nAm&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported units for source signals: </span><span class="si">{</span><span class="n">source_units</span><span class="si">}</span><span class="s2">. Expected FIFF.FIFF_UNIT_AM.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">orientation_type</span> <span class="o">==</span> <span class="s1">&#39;fixed&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_hat_active_indices</span><span class="p">,</span> <span class="n">x_hat_active_scaled</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Non-Zero Posterior Mean - Estimated active (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_hat_active_indices</span><span class="p">)</span><span class="si">}</span><span class="s1"> sources)&#39;</span><span class="p">)</span>


            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_active_indices</span><span class="p">,</span> <span class="n">x_active_scaled</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Non-Zero Ground Truth (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_active_indices</span><span class="p">)</span><span class="si">}</span><span class="s1"> simulated Sources)&#39;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Active voxels&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Amplitude of averaged sources (across time) and their estimates (</span><span class="si">{</span><span class="n">source_units</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span> <span class="ow">or</span> <span class="sa">f</span><span class="s1">&#39;Active Sources fixed orientation, (Only Non-Zero Sources) of Averaged Activities across Time Steps&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Total Sources: </span><span class="si">{</span><span class="n">n_sources</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">orientations</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]</span>

            <span class="n">x_active_indices_flat</span> <span class="o">=</span> <span class="n">x_active_indices</span> <span class="o">//</span> <span class="mi">3</span>
            <span class="n">x_active_indices_orientations_flat</span> <span class="o">=</span> <span class="n">x_active_indices</span> <span class="o">%</span> <span class="mi">3</span>
            <span class="c1"># Create a map from original source index to its value for each orientation</span>
            <span class="n">x_active_indices_map</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Only consider non-zero ground truth</span>
                    <span class="n">orient</span> <span class="o">=</span> <span class="n">x_active_indices_orientations_flat</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">src_idx</span> <span class="o">=</span> <span class="n">x_active_indices_flat</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">x_active_indices_map</span><span class="p">[</span><span class="n">orient</span><span class="p">][</span><span class="n">src_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            
            <span class="c1"># For Estimated (x_hat)</span>
            <span class="n">x_hat_active_indices_flat</span> <span class="o">=</span> <span class="n">x_hat_active_indices</span> <span class="o">//</span> <span class="mi">3</span>
            <span class="n">x_hat_active_indices_orientations_flat</span> <span class="o">=</span> <span class="n">x_hat_active_indices</span> <span class="o">%</span> <span class="mi">3</span>
            <span class="n">x_hat_active_indices_map</span> <span class="o">=</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_hat</span><span class="p">):</span>
                <span class="n">orient</span> <span class="o">=</span> <span class="n">x_hat_active_indices_orientations_flat</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">src_idx</span> <span class="o">=</span> <span class="n">x_hat_active_indices_flat</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">x_hat_active_indices_map</span><span class="p">[</span><span class="n">orient</span><span class="p">][</span><span class="n">src_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>


            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span> <span class="c1"># i is the target orientation index (0, 1, 2)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">x_active_indices</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x_hat_active_indices</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Orientation </span><span class="si">{</span><span class="n">orientations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> (No active components to plot)&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
                    <span class="k">continue</span>
                
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_hat_active_indices</span><span class="p">,</span> <span class="n">x_hat_one_trial_one_time</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Non-Zero Posterior Mean - Estimated active (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_hat_active_indices</span><span class="p">)</span><span class="si">}</span><span class="s1"> sources)&#39;</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_active_indices</span><span class="p">,</span> <span class="n">x_active_indices</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Non-Zero Ground Truth (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_active_indices</span><span class="p">)</span><span class="si">}</span><span class="s1"> simulated Sources)&#39;</span><span class="p">)</span>
                
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Index of Active (Non-zero) Sources&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Amplitude of averaged sources (across time) and their estimates (</span><span class="si">{</span><span class="n">source_units</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Active Sources Comparison for free orientation, (Only Non-Zero Sources) of Averaged Activities across Time Steps&#39;</span><span class="p">)</span>

                <span class="c1"># all_unique_src_indices_on_axis = sorted(list(set(x_active_indices + active_indices)))</span>
                <span class="n">all_unique_src_indices_on_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_sources</span><span class="p">)</span>
                <span class="c1"># n_sources_this_axis = len(all_unique_src_indices_on_axis)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Total Sources: </span><span class="si">{</span><span class="n">n_sources</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="c1"># ax.axhline(0, color=&#39;grey&#39;, linestyle=&#39;--&#39;, linewidth=0.8)</span>
                <span class="k">if</span> <span class="n">all_unique_src_indices_on_axis</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">all_unique_src_indices_on_axis</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">s_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">s_idx</span> <span class="ow">in</span> <span class="n">all_unique_src_indices_on_axis</span><span class="p">])</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="s1">&#39;Original Source Index&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span> 
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active Sources Comparison for free orientation, (Only Non-Zero Sources) of Averaged Activities across Time Steps&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_figure_output</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">file_name</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;active_sources&quot;</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">show</span><span class="p">)</span></div>

     
<div class="viewcode-block" id="Visualizer.plot_ci">
<a class="viewcode-back" href="../../api/visualization/Visualizer.html#calibrain.visualization.Visualizer.plot_ci">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_ci</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_one_trial_one_time</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">x_hat_one_trial_one_time</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">x_active_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">x_hat_active_indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">n_sources</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">source_units</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">ci_lower</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">ci_upper</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">confidence_levels</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">orientation_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fixed&quot;</span><span class="p">,</span>
        <span class="n">sharey</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;active_sources_ci&quot;</span><span class="p">,</span>
        <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">source_units</span> <span class="o">==</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_AM</span><span class="p">:</span> <span class="c1">#TODO: check whether we need to copy()</span>
            <span class="n">x_scaled</span> <span class="o">=</span> <span class="n">x_one_trial_one_time</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">x_hat_scaled</span> <span class="o">=</span> <span class="n">x_hat_one_trial_one_time</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">ci_lower_scaled</span> <span class="o">=</span> <span class="n">ci_lower</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">ci_upper_scaled</span> <span class="o">=</span> <span class="n">ci_upper</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">1e9</span>
            <span class="n">source_units</span> <span class="o">=</span> <span class="s2">&quot;nAm&quot;</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported units for source signals: </span><span class="si">{</span><span class="n">source_units</span><span class="si">}</span><span class="s2">. Expected FIFF.FIFF_UNIT_AM.&quot;</span><span class="p">)</span>            
    
        <span class="c1"># Create grid of subplots for all confidence levels</span>
        <span class="n">n_levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">confidence_levels</span><span class="p">)</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_levels</span><span class="p">)</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_levels</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="n">sharey</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="n">matched_indices</span> <span class="o">=</span> <span class="n">x_hat_active_indices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">x_hat_active_indices</span><span class="p">,</span> <span class="n">x_active_indices</span><span class="p">)]</span>
        
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">confidence_level_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">confidence_levels</span><span class="p">):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_indices</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ci_lower_current</span> <span class="o">=</span> <span class="n">ci_lower_scaled</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="n">ci_upper_current</span> <span class="o">=</span> <span class="n">ci_upper_scaled</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

                <span class="n">yerr_lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">x_hat_scaled</span><span class="p">[</span><span class="n">matched_indices</span><span class="p">]</span> <span class="o">-</span> <span class="n">ci_lower_current</span>
                <span class="p">)</span>
                <span class="n">yerr_upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">ci_upper_current</span> <span class="o">-</span> <span class="n">x_hat_scaled</span><span class="p">[</span><span class="n">matched_indices</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">yerr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">yerr_lower</span><span class="p">,</span> <span class="n">yerr_upper</span><span class="p">])</span>
                     
                <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
                    <span class="n">matched_indices</span><span class="p">,</span>
                    <span class="n">x_hat_scaled</span><span class="p">[</span><span class="n">matched_indices</span><span class="p">],</span>
                    <span class="n">yerr</span><span class="p">,</span>
                    <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span>
                    <span class="c1"># alpha=0.7,</span>
                    <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Active posterior mean (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_hat_active_indices</span><span class="p">)</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">n_sources</span><span class="si">}</span><span class="s1">)&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Matched voxel locations: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_indices</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">),</span>
                    <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add a dummy handle for the error bar to the legend</span>
                <span class="n">errorbar_handle</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
                    <span class="p">[],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s1">&#39;Active posterior mean (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_hat_active_indices</span><span class="p">)</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">n_sources</span><span class="si">}</span><span class="s1">)&#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Matched indices: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_indices</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_active_indices</span><span class="p">,</span> <span class="n">x_scaled</span><span class="p">[</span><span class="n">x_active_indices</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">70</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Active simulated sources (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">x_active_indices</span><span class="p">)</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">n_sources</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;CI Level=</span><span class="si">{</span><span class="n">confidence_level_val</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Shared legend: collect all handles/labels</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[:</span><span class="n">n_levels</span><span class="p">]:</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>

        <span class="c1"># Hide unused subplots</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="n">n_levels</span><span class="p">:]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
                    
        <span class="c1"># Place the legend below the supertitle, centered</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.015</span><span class="p">))</span>

        <span class="c1"># Place the legend in the empty subplot</span>
        <span class="c1"># axes[11].legend(by_label.values(), by_label.keys(), loc=&#39;center&#39;, fontsize=&#39;large&#39;, frameon=True)</span>
        <span class="c1"># axes[11].set_title(&quot;Legend&quot;, fontsize=16)</span>

        <span class="c1"># Shared x/y labels for the whole figure</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s1">&#39;Active voxels&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">supylabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Amplitude (</span><span class="si">{</span><span class="n">source_units</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Confidence Intervals for Active Reconstructed Sources&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span>        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_figure_output</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">show</span><span class="p">)</span></div>

                          
<div class="viewcode-block" id="Visualizer.plot_calibration_curve">
<a class="viewcode-back" href="../../api/visualization/Visualizer.html#calibrain.visualization.Visualizer.plot_calibration_curve">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_calibration_curve</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">confidence_levels</span><span class="p">,</span>
        <span class="n">empirical_coverage</span><span class="p">,</span>
        <span class="n">result</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># This dictionary is expected to contain the metrics</span>
        <span class="n">which_legend</span><span class="o">=</span><span class="s2">&quot;active_indices&quot;</span><span class="p">,</span> <span class="c1"># or &quot;all_sources&quot;</span>
        <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;calibration_curve&#39;</span><span class="p">,</span>
        <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualizes the calibration curve.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - empirical_coverage (np.ndarray): 1D array of empirical coverage values,</span>
<span class="sd">                                            corresponding to each confidence level in self.confidence_levels.</span>
<span class="sd">        - results (dict): Dictionary possibly containing calibration metrics.</span>
<span class="sd">        - which_legend (str): Specifies which set of metrics to display in the legend.</span>
<span class="sd">        - file_name (str): Base name for the saved plot file.</span>
<span class="sd">        &quot;&quot;&quot;</span>            
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

        <span class="c1"># Plot the empirical coverage line and scatter points</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">confidence_levels</span><span class="p">,</span> <span class="n">empirical_coverage</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Empirical Coverage&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">confidence_levels</span><span class="p">,</span> <span class="n">empirical_coverage</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

        <span class="c1"># Plot the ideal calibration line (diagonal)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">confidence_levels</span><span class="p">,</span> <span class="n">confidence_levels</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ideal Calibration&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>

        <span class="c1"># Fill the area between empirical and ideal calibration</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="n">confidence_levels</span><span class="p">,</span> 
            <span class="n">empirical_coverage</span><span class="p">,</span> 
            <span class="n">confidence_levels</span><span class="p">,</span> 
            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> 
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;AUC Deviation Area&quot;</span>
        <span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Nominal Confidence Level&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Empirical Coverage&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">file_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>

        <span class="c1"># Prepare legend: start with existing plot elements</span>
        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        
        <span class="c1"># Determine which set of metrics to display</span>
        <span class="k">if</span> <span class="n">which_legend</span> <span class="o">==</span> <span class="s2">&quot;active_indices&quot;</span><span class="p">:</span>
            <span class="n">metrics_to_display</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;auc_deviation_active_indices&#39;</span><span class="p">:</span> <span class="s1">&#39;AUC area&#39;</span><span class="p">,</span>
                <span class="s1">&#39;max_positive_deviation_active_indices&#39;</span><span class="p">:</span> <span class="s1">&#39;Max Positive Dev.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;max_negative_deviation_active_indices&#39;</span><span class="p">:</span> <span class="s1">&#39;Max Negative Dev.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;max_absolute_deviation_active_indices&#39;</span><span class="p">:</span> <span class="s1">&#39;Max Abs Dev.&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="n">which_legend</span> <span class="o">==</span> <span class="s2">&quot;all_sources&quot;</span><span class="p">:</span>
            <span class="n">metrics_to_display</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;auc_deviation_all_sources&#39;</span><span class="p">:</span> <span class="s1">&#39;AUC area&#39;</span><span class="p">,</span>
                <span class="s1">&#39;max_positive_deviation_all_sources&#39;</span><span class="p">:</span> <span class="s1">&#39;Max Positive Dev.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;max_negative_deviation_all_sources&#39;</span><span class="p">:</span> <span class="s1">&#39;Max Negative Dev.&#39;</span><span class="p">,</span>
                <span class="s1">&#39;max_absolute_deviation_all_sources&#39;</span><span class="p">:</span> <span class="s1">&#39;Max Abs Dev.&#39;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown which_legend value: </span><span class="si">{</span><span class="n">which_legend</span><span class="si">}</span><span class="s2">. Expected &#39;active_indices&#39; or &#39;all_sources&#39;.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
            <span class="n">separator_handle</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;---------------------------&quot;</span><span class="p">)</span>
            <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">separator_handle</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">separator_handle</span><span class="o">.</span><span class="n">get_label</span><span class="p">())</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">display_name</span> <span class="ow">in</span> <span class="n">metrics_to_display</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">result</span> <span class="ow">and</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">dummy_handle</span> <span class="o">=</span> <span class="n">mlines</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([],</span> <span class="p">[],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">handles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dummy_handle</span><span class="p">)</span>
                    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">display_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create the legend with potentially added metric values</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">])</span> 

        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_figure_output</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">show</span><span class="p">)</span></div>



    <span class="c1"># ------------------------------------------------</span>
    <span class="c1"># Wrap up all visualizations into a single method</span>
    <span class="c1"># ------------------------------------------------</span>

<div class="viewcode-block" id="Visualizer.plot_all">
<a class="viewcode-back" href="../../api/visualization/Visualizer.html#calibrain.visualization.Visualizer.plot_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_all</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_trials</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">x_active_indices_trials</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">x_hat_one_trial</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>        
        <span class="n">x_hat_active_indices_one_trial</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_clean_trials</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">y_noisy_trials</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">trial_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">n_sources</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">subject</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">subjects_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fwd_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nnz</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">ERP_config</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">source_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_AM</span><span class="p">,</span>
        <span class="n">sensor_units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">FIFF</span><span class="o">.</span><span class="n">FIFF_UNIT_V</span><span class="p">,</span>
        <span class="n">confidence_levels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">empirical_coverages</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ci_lower</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ci_upper</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">orientation_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fixed&quot;</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">experiment_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Comprehensive visualization wrapper that generates all plots for experiment analysis.</span>
<span class="sd">        </span>
<span class="sd">        This is a high-level wrapper function that orchestrates multiple visualization </span>
<span class="sd">        methods to create a complete set of plots for ERP source localization analysis.</span>
<span class="sd">        </span>
<span class="sd">        **Generated Visualizations:**</span>
<span class="sd">        - Source signal plots (individual and all trials)</span>
<span class="sd">        - Sensor signal plots (stacked and concatenated)</span>
<span class="sd">        - 3D brain surface plots (if available)</span>
<span class="sd">        - Source-sensor comparison plots</span>
<span class="sd">        - Active source analysis plots</span>
<span class="sd">        - Confidence interval plots</span>
<span class="sd">        - Calibration curve plots</span>
<span class="sd">        </span>
<span class="sd">        **Called Methods:**</span>
<span class="sd">        - :meth:`plot_source_signals` - Source time series visualization</span>
<span class="sd">        - :meth:`plot_sensor_signals` - Sensor measurements visualization  </span>
<span class="sd">        - :meth:`plot_stc_3d_brain` - 3D brain surface visualization</span>
<span class="sd">        - :meth:`plot_source_and_sensors` - Combined source-sensor plots</span>
<span class="sd">        - :meth:`plot_active_sources` - Active source comparison</span>
<span class="sd">        - :meth:`plot_ci` - Confidence interval visualization</span>
<span class="sd">        - :meth:`plot_calibration_curve` - Uncertainty calibration analysis</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x_trials : np.ndarray</span>
<span class="sd">            Source activity trials, shape (n_trials, n_sources, n_times)</span>
<span class="sd">        x_active_indices_trials : np.ndarray</span>
<span class="sd">            Active source indices per trial</span>
<span class="sd">        x_hat_one_trial : np.ndarray</span>
<span class="sd">            Estimated source activity for one trial</span>
<span class="sd">        x_hat_active_indices_one_trial : np.ndarray</span>
<span class="sd">            Estimated active source indices for one trial</span>
<span class="sd">        y_clean_trials : np.ndarray</span>
<span class="sd">            Clean sensor measurements, shape (n_trials, n_sensors, n_times)</span>
<span class="sd">        y_noisy_trials : np.ndarray</span>
<span class="sd">            Noisy sensor measurements, shape (n_trials, n_sensors, n_times)</span>
<span class="sd">        trial_idx : int, optional</span>
<span class="sd">            Trial index for single-trial visualizations, by default 0</span>
<span class="sd">        n_sources : int, optional</span>
<span class="sd">            Total number of sources, by default 1</span>
<span class="sd">        subject : str, optional</span>
<span class="sd">            Subject name for brain plots</span>
<span class="sd">        subjects_dir : str, optional</span>
<span class="sd">            FreeSurfer subjects directory</span>
<span class="sd">        fwd_path : str, optional</span>
<span class="sd">            Forward model path</span>
<span class="sd">        nnz : int, optional</span>
<span class="sd">            Number of non-zero sources, by default 1</span>
<span class="sd">        ERP_config : dict, optional</span>
<span class="sd">            ERP configuration parameters</span>
<span class="sd">        sample_idx : int, optional</span>
<span class="sd">            Time sample index for brain plots, by default 0</span>
<span class="sd">        source_units : str, optional</span>
<span class="sd">            Source signal units, by default FIFF.FIFF_UNIT_AM</span>
<span class="sd">        sensor_units : str, optional</span>
<span class="sd">            Sensor signal units, by default FIFF.FIFF_UNIT_V</span>
<span class="sd">        confidence_levels : np.ndarray, optional</span>
<span class="sd">            Confidence levels for uncertainty analysis</span>
<span class="sd">        empirical_coverages : dict, optional</span>
<span class="sd">            Empirical coverage data for calibration</span>
<span class="sd">        ci_lower : np.ndarray, optional</span>
<span class="sd">            Lower confidence bounds</span>
<span class="sd">        ci_upper : np.ndarray, optional</span>
<span class="sd">            Upper confidence bounds</span>
<span class="sd">        orientation_type : str, optional</span>
<span class="sd">            Source orientation type, by default &quot;fixed&quot;</span>
<span class="sd">        result : dict, optional</span>
<span class="sd">            Analysis results containing metrics</span>
<span class="sd">        experiment_dir : str, optional</span>
<span class="sd">            Experiment directory for saving plots</span>
<span class="sd">            </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This wrapper function automatically saves all plots to organized subdirectories:</span>
<span class="sd">        - `data_simulation/` - Data visualization plots</span>
<span class="sd">        - `uncertainty_analysis/` - Uncertainty quantification plots</span>
<span class="sd">        </span>
<span class="sd">        All plots are saved with `show=False` for batch processing compatibility.</span>
<span class="sd">        </span>
<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; viz = Visualizer(base_save_path=&quot;results/figures&quot;)</span>
<span class="sd">        &gt;&gt;&gt; viz.plot_all(</span>
<span class="sd">        ...     x_trials=x_trials,</span>
<span class="sd">        ...     x_active_indices_trials=active_indices,</span>
<span class="sd">        ...     x_hat_one_trial=x_hat,</span>
<span class="sd">        ...     # ... other parameters</span>
<span class="sd">        ... )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">x_one_trial</span> <span class="o">=</span> <span class="n">x_trials</span><span class="p">[</span><span class="n">trial_idx</span><span class="p">]</span>
        <span class="n">x_active_indices_one_trial</span> <span class="o">=</span> <span class="n">x_active_indices_trials</span><span class="p">[</span><span class="n">trial_idx</span><span class="p">]</span>
        <span class="n">x_one_trial_avg_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_one_trial</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x_hat_one_trial_avg_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_hat_one_trial</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">y_clean_one_trial</span> <span class="o">=</span> <span class="n">y_clean_trials</span><span class="p">[</span><span class="n">trial_idx</span><span class="p">]</span>
        <span class="n">y_noisy_one_trial</span> <span class="o">=</span> <span class="n">y_noisy_trials</span><span class="p">[</span><span class="n">trial_idx</span><span class="p">]</span>
        
        <span class="c1"># =========================</span>
        <span class="c1"># 1. Plot simulated data</span>
        <span class="c1"># =========================</span>
        
        <span class="c1"># Plot sources (all trials)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_source_signals</span><span class="p">(</span>
            <span class="n">ERP_config</span><span class="o">=</span><span class="n">ERP_config</span><span class="p">,</span>
            <span class="n">x_trials</span><span class="o">=</span><span class="n">x_trials</span><span class="p">,</span>
            <span class="n">x_active_indices</span><span class="o">=</span><span class="n">x_active_indices_trials</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="n">source_units</span><span class="p">,</span>
            <span class="n">trial_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Source Trials (All)&quot;</span><span class="p">,</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="s2">&quot;data_simulation&quot;</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;source_trials_all&quot;</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Plot sensors (all trials) with selected channels: y_noisy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_sensor_signals</span><span class="p">(</span>
            <span class="n">ERP_config</span><span class="o">=</span><span class="n">ERP_config</span><span class="p">,</span>
            <span class="n">y_trials</span><span class="o">=</span><span class="n">y_noisy_trials</span><span class="p">,</span>
            <span class="n">channels</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>  <span class="c1"># or &quot;all&quot;</span>
            <span class="n">units</span><span class="o">=</span><span class="n">sensor_units</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;stack&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Sensor Signals (All Trials stacked)&quot;</span><span class="p">,</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="s2">&quot;data_simulation&quot;</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;sensor_stack_trials_noisy&quot;</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Concatenated trials: y_noisy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_sensor_signals</span><span class="p">(</span>
            <span class="n">ERP_config</span><span class="o">=</span><span class="n">ERP_config</span><span class="p">,</span>
            <span class="n">y_trials</span><span class="o">=</span><span class="n">y_noisy_trials</span><span class="p">,</span>
            <span class="c1"># channels=[0, 10],  # or &quot;all&quot;</span>
            <span class="n">units</span><span class="o">=</span><span class="n">sensor_units</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;concatenate&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Sensor Signals (All trials concatenated)&quot;</span><span class="p">,</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="s2">&quot;data_simulation&quot;</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;sensor_concatenate_trials_noisy&quot;</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># Concatenated trials: y_clean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_sensor_signals</span><span class="p">(</span>
            <span class="n">ERP_config</span><span class="o">=</span><span class="n">ERP_config</span><span class="p">,</span>
            <span class="n">y_trials</span><span class="o">=</span><span class="n">y_clean_trials</span><span class="p">,</span>
            <span class="c1"># channels=[0, 10],  # or &quot;all&quot;</span>
            <span class="n">units</span><span class="o">=</span><span class="n">sensor_units</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;concatenate&quot;</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Sensor Signals (All trials concatenated)&quot;</span><span class="p">,</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="s2">&quot;data_simulation&quot;</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;sensor_concatenate_trials_clean&quot;</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_stc_3d_brain</span><span class="p">(</span>
            <span class="n">ERP_config</span><span class="o">=</span><span class="n">ERP_config</span><span class="p">,</span>
            <span class="n">x_one_trial</span><span class="o">=</span><span class="n">x_one_trial</span><span class="p">,</span>
            <span class="n">x_hat_one_trial</span><span class="o">=</span><span class="n">x_hat_one_trial</span><span class="p">,</span>
            <span class="n">orientations</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lateral&#39;</span><span class="p">,</span> <span class="s1">&#39;medial&#39;</span><span class="p">,</span> <span class="s1">&#39;dorsal&#39;</span><span class="p">,</span> <span class="s1">&#39;ventral&#39;</span><span class="p">],</span>
            <span class="n">source_units</span><span class="o">=</span><span class="n">source_units</span><span class="p">,</span>
            <span class="n">sample_idx</span><span class="o">=</span><span class="n">sample_idx</span><span class="p">,</span>
            <span class="n">subject</span><span class="o">=</span><span class="n">subject</span><span class="p">,</span>
            <span class="n">subjects_dir</span><span class="o">=</span><span class="n">subjects_dir</span><span class="p">,</span>
            <span class="n">fwd_path</span><span class="o">=</span><span class="n">fwd_path</span><span class="p">,</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="n">experiment_dir</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;brain&quot;</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">plot_source_and_sensors</span><span class="p">(</span>
            <span class="n">x_one_trial</span><span class="o">=</span><span class="n">x_one_trial</span><span class="p">,</span>
            <span class="n">x_active_indices</span><span class="o">=</span><span class="n">x_active_indices_one_trial</span><span class="p">,</span>
            <span class="n">y_clean_one_trial</span><span class="o">=</span><span class="n">y_clean_one_trial</span><span class="p">,</span>
            <span class="n">y_noisy_one_trial</span><span class="o">=</span><span class="n">y_noisy_one_trial</span><span class="p">,</span>
            <span class="n">nnz</span><span class="o">=</span><span class="n">nnz</span><span class="p">,</span>
            <span class="n">ERP_config</span><span class="o">=</span><span class="n">ERP_config</span><span class="p">,</span>
            <span class="n">source_units</span><span class="o">=</span><span class="n">source_units</span><span class="p">,</span>
            <span class="n">sensor_units</span><span class="o">=</span><span class="n">sensor_units</span><span class="p">,</span>
            <span class="n">orientation_type</span><span class="o">=</span><span class="n">orientation_type</span><span class="p">,</span>
            <span class="n">max_sensors</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">plot_sensors_together</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;source_sensor_data.png&#39;</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;data_simulation&#39;</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>        
        
        <span class="c1"># =========================</span>
        <span class="c1"># 2. Plot uncertainty analysis figures</span>
        <span class="c1"># =========================</span>
        <span class="c1"># Plot active sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_active_sources</span><span class="p">(</span>
            <span class="n">x_one_trial_one_time</span><span class="o">=</span><span class="n">x_one_trial_avg_time</span><span class="p">,</span>
            <span class="n">x_hat_one_trial_one_time</span><span class="o">=</span><span class="n">x_hat_one_trial_avg_time</span><span class="p">,</span>
            <span class="n">x_active_indices</span><span class="o">=</span><span class="n">x_active_indices_one_trial</span><span class="p">,</span>
            <span class="n">x_hat_active_indices</span><span class="o">=</span><span class="n">x_hat_active_indices_one_trial</span><span class="p">,</span>
            <span class="n">n_sources</span><span class="o">=</span><span class="n">n_sources</span><span class="p">,</span>
            <span class="n">source_units</span><span class="o">=</span><span class="n">source_units</span><span class="p">,</span>
            <span class="n">orientation_type</span><span class="o">=</span> <span class="n">orientation_type</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;uncertainty_analysis&quot;</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;active_sources&quot;</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="c1"># Plot confidence intervals - unshared y-axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_ci</span><span class="p">(</span>
            <span class="n">x_one_trial_one_time</span><span class="o">=</span><span class="n">x_one_trial_avg_time</span><span class="p">,</span>
            <span class="n">x_hat_one_trial_one_time</span><span class="o">=</span><span class="n">x_hat_one_trial_avg_time</span><span class="p">,</span>
            <span class="n">x_active_indices</span><span class="o">=</span><span class="n">x_active_indices_one_trial</span><span class="p">,</span>
            <span class="n">x_hat_active_indices</span><span class="o">=</span><span class="n">x_hat_active_indices_one_trial</span><span class="p">,</span>
            <span class="n">n_sources</span><span class="o">=</span><span class="n">n_sources</span><span class="p">,</span>
            <span class="n">source_units</span><span class="o">=</span><span class="n">source_units</span><span class="p">,</span>
            <span class="n">ci_lower</span><span class="o">=</span><span class="n">ci_lower</span><span class="p">,</span>
            <span class="n">ci_upper</span><span class="o">=</span><span class="n">ci_upper</span><span class="p">,</span>
            <span class="n">confidence_levels</span><span class="o">=</span><span class="n">confidence_levels</span><span class="p">,</span>
            <span class="n">orientation_type</span><span class="o">=</span><span class="n">orientation_type</span><span class="p">,</span>
            <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;uncertainty_analysis&quot;</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;confidence_intervals&quot;</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Plot confidence intervals - shared y-axis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_ci</span><span class="p">(</span>
            <span class="n">x_one_trial_one_time</span><span class="o">=</span><span class="n">x_one_trial_avg_time</span><span class="p">,</span>
            <span class="n">x_hat_one_trial_one_time</span><span class="o">=</span><span class="n">x_hat_one_trial_avg_time</span><span class="p">,</span>
            <span class="n">x_active_indices</span><span class="o">=</span><span class="n">x_active_indices_one_trial</span><span class="p">,</span>
            <span class="n">x_hat_active_indices</span><span class="o">=</span><span class="n">x_hat_active_indices_one_trial</span><span class="p">,</span>
            <span class="n">n_sources</span><span class="o">=</span><span class="n">n_sources</span><span class="p">,</span>
            <span class="n">source_units</span><span class="o">=</span><span class="n">source_units</span><span class="p">,</span>
            <span class="n">ci_lower</span><span class="o">=</span><span class="n">ci_lower</span><span class="p">,</span>
            <span class="n">ci_upper</span><span class="o">=</span><span class="n">ci_upper</span><span class="p">,</span>
            <span class="n">confidence_levels</span><span class="o">=</span><span class="n">confidence_levels</span><span class="p">,</span>
            <span class="n">orientation_type</span><span class="o">=</span><span class="n">orientation_type</span><span class="p">,</span>
            <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="s2">&quot;uncertainty_analysis&quot;</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="s2">&quot;confidence_intervals_shared-Yaxis&quot;</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
        <span class="p">)</span>
        
        <span class="c1"># plot calibration curve - active sources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_calibration_curve</span><span class="p">(</span>
            <span class="n">confidence_levels</span><span class="o">=</span><span class="n">confidence_levels</span><span class="p">,</span>
            <span class="n">empirical_coverage</span><span class="o">=</span><span class="n">empirical_coverages</span><span class="p">[</span><span class="s1">&#39;active_indices&#39;</span><span class="p">],</span>
            <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
            <span class="n">which_legend</span><span class="o">=</span><span class="s2">&quot;active_indices&quot;</span><span class="p">,</span> <span class="c1"># or &quot;all_sources&quot;</span>
            <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;calibration_curve_active_sources&#39;</span><span class="p">,</span>
            <span class="n">save_path</span><span class="o">=</span><span class="s1">&#39;uncertainty_analysis&#39;</span><span class="p">,</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>




<span class="c1"># def main():</span>
<span class="c1">#     from calibrain import SourceSimulator</span>
<span class="c1">#     from calibrain import SensorSimulator</span>

<span class="c1">#     logging.basicConfig(</span>
<span class="c1">#         level=logging.INFO,  # or DEBUG</span>
<span class="c1">#         format=&quot;%(asctime)s | %(levelname)s | %(name)s | %(message)s&quot;,</span>
<span class="c1">#         handlers=[</span>
<span class="c1">#             logging.StreamHandler(),  # Console</span>
<span class="c1">#             logging.FileHandler(&quot;Vizualisation.log&quot;, mode=&quot;w&quot;)  # Log to file</span>
<span class="c1">#         ]</span>
<span class="c1">#     )</span>
<span class="c1">#     logger = logging.getLogger(&quot;SourceSimulator&quot;)</span>

<span class="c1">#     ERP_config = {</span>
<span class="c1">#         &quot;tmin&quot;: -0.5,</span>
<span class="c1">#         &quot;tmax&quot;: 0.5,</span>
<span class="c1">#         &quot;stim_onset&quot;: 0.0,</span>
<span class="c1">#         &quot;sfreq&quot;: 250,</span>
<span class="c1">#         &quot;fmin&quot;: 1,</span>
<span class="c1">#         &quot;fmax&quot;: 5,</span>
<span class="c1">#         &quot;amplitude&quot;: 10.0, # 30.0</span>
<span class="c1">#         &quot;random_erp_timing&quot;: True,</span>
<span class="c1">#         &quot;erp_min_length&quot;: None,</span>
<span class="c1">#     }</span>

<span class="c1">#     n_trials=4</span>
<span class="c1">#     orientation_type=&quot;fixed&quot;</span>
<span class="c1">#     n_sources=10</span>
<span class="c1">#     nnz=5</span>
<span class="c1">#     global_seed=42</span>

<span class="c1">#     source_simulator = SourceSimulator(</span>
<span class="c1">#         ERP_config=ERP_config,</span>
<span class="c1">#         logger=logger</span>
<span class="c1">#     )</span>
<span class="c1">#     print(f&quot;Default units for source signals: {source_simulator.source_units}&quot;)</span>

<span class="c1">#     x_trials, active_indices_trials = source_simulator.simulate(</span>
<span class="c1">#         orientation_type=orientation_type,</span>
<span class="c1">#         n_sources=n_sources,</span>
<span class="c1">#         nnz=nnz,</span>
<span class="c1">#         n_trials=n_trials,</span>
<span class="c1">#         global_seed=global_seed,</span>
<span class="c1">#     )</span>
<span class="c1">#     # source_simulator.source_units = &quot;Am&quot;  # Set units for source signals</span>
<span class="c1">#     trial_idx = 0</span>

<span class="c1">#     viz = Visualizer(base_save_path=&quot;testViz&quot;, logger=logger)</span>

<span class="c1">#     # Plot sources (single trial)</span>
<span class="c1">#     viz.plot_source_signals(</span>
<span class="c1">#         ERP_config=ERP_config,</span>
<span class="c1">#         x=x_trials,</span>
<span class="c1">#         active_indices=active_indices_trials,</span>
<span class="c1">#         units=source_simulator.source_units,</span>
<span class="c1">#         trial_idx=trial_idx,</span>
<span class="c1">#         title=f&quot;Source Activity - Trial {trial_idx+1}&quot;,</span>
<span class="c1">#         save_dir=&quot;data_simulation&quot;,</span>
<span class="c1">#         file_name=f&quot;source_trial_{trial_idx+1}&quot;,</span>
<span class="c1">#         show=False,</span>
<span class="c1">#     )</span>

<span class="c1">#     # Plot sources (all trials)</span>
<span class="c1">#     viz.plot_source_signals(</span>
<span class="c1">#         ERP_config=ERP_config,</span>
<span class="c1">#         x=x_trials,</span>
<span class="c1">#         active_indices=active_indices_trials,</span>
<span class="c1">#         units=source_simulator.source_units,</span>
<span class="c1">#         trial_idx=None,</span>
<span class="c1">#         title=&quot;Source Activity - All Trials&quot;,</span>
<span class="c1">#         save_dir=&quot;data_simulation&quot;,</span>
<span class="c1">#         file_name=&quot;source_trials_all&quot;,</span>
<span class="c1">#         show=False,</span>
<span class="c1">#     )</span>


<span class="c1">#     sensor_simulator = SensorSimulator(</span>
<span class="c1">#         logger=logger,</span>
<span class="c1">#     )</span>
<span class="c1">#     print(f&quot;Default units for sensor signals: {sensor_simulator.sensor_units}&quot;)</span>

<span class="c1">#     n_sensors = 10</span>
<span class="c1">#     L = np.random.randn(n_sensors, n_sources)</span>

<span class="c1">#     # Simulate sensor data</span>
<span class="c1">#     y_clean, y_noisy, noise, noise_var = sensor_simulator.simulate(</span>
<span class="c1">#         x_trials,</span>
<span class="c1">#         L,</span>
<span class="c1">#         orientation_type=&quot;fixed&quot;,</span>
<span class="c1">#         alpha_SNR=0.5,</span>
<span class="c1">#         n_trials=n_trials,</span>
<span class="c1">#     )</span>
<span class="c1">#     # sensor_simulator.sensor_units = &quot;T&quot;</span>


<span class="c1">#     # Plot sensors (single trial) with selected channels: y_clean</span>
<span class="c1">#     viz.plot_sensor_signals(</span>
<span class="c1">#         ERP_config=ERP_config,</span>
<span class="c1">#         y_trials=y_clean,</span>
<span class="c1">#         trial_idx=trial_idx,</span>
<span class="c1">#         # channels=[0, 1],  # or &quot;all&quot;</span>
<span class="c1">#         units=sensor_simulator.sensor_units,</span>
<span class="c1">#         mode=&quot;single&quot;,</span>
<span class="c1">#         title=f&quot;Sensor Trial {trial_idx+1}&quot;,</span>
<span class="c1">#         save_dir=&quot;data_simulation&quot;,</span>
<span class="c1">#         file_name=f&quot;sensor_trial_{trial_idx+1}_clean&quot;,</span>
<span class="c1">#         show=True</span>
<span class="c1">#     )</span>

<span class="c1">#     # Plot sensors (all trials) with selected channels: y_clean</span>
<span class="c1">#     viz.plot_sensor_signals(</span>
<span class="c1">#         ERP_config=ERP_config,</span>
<span class="c1">#         y_trials=y_clean,</span>
<span class="c1">#         mode=&quot;stack&quot;,</span>
<span class="c1">#         channels=[2, 3],</span>
<span class="c1">#         units=sensor_simulator.sensor_units,</span>
<span class="c1">#         save_dir=&quot;data_simulation&quot;,</span>
<span class="c1">#         title=&quot;Sensor Signals (All Trials)&quot;,</span>
<span class="c1">#         file_name=&quot;sensor_all_trials_clean&quot;,</span>
<span class="c1">#         show=False</span>
<span class="c1">#     )</span>

<span class="c1">#     # Concatenated trials: y_clean</span>
<span class="c1">#     viz.plot_sensor_signals(</span>
<span class="c1">#         ERP_config=ERP_config,</span>
<span class="c1">#         y_trials=y_clean,</span>
<span class="c1">#         mode=&quot;concatenate&quot;,</span>
<span class="c1">#         channels=[0, 2, 3],  # or &quot;all&quot;</span>
<span class="c1">#         units=sensor_simulator.sensor_units,</span>
<span class="c1">#         title=&quot;Sensor Signals (Concatenated)&quot;,</span>
<span class="c1">#         save_dir=&quot;data_simulation&quot;,</span>
<span class="c1">#         file_name=&quot;sensor_concatenated_clean&quot;,</span>
<span class="c1">#         show=False</span>
<span class="c1">#     )</span>

<span class="c1">#     # Plot sensors (single trial) with selected channels: y_noisy</span>
<span class="c1">#     viz.plot_sensor_signals(</span>
<span class="c1">#         ERP_config=ERP_config,</span>
<span class="c1">#         y_trials= y_noisy,</span>
<span class="c1">#         trial_idx=trial_idx,</span>
<span class="c1">#         channels=[0, 1],  # or &quot;all&quot;</span>
<span class="c1">#         units=sensor_simulator.sensor_units,</span>
<span class="c1">#         mode=&quot;single&quot;,</span>
<span class="c1">#         title=f&quot;Sensor Trial {trial_idx+1}&quot;,</span>
<span class="c1">#         save_dir=&quot;data_simulation&quot;,</span>
<span class="c1">#         file_name=f&quot;sensor_trial_{trial_idx+1}_noisy&quot;,</span>
<span class="c1">#         show=False</span>
<span class="c1">#     )</span>

<span class="c1">#     # Plot sensors (all trials) with selected channels: y_noisy</span>
<span class="c1">#     viz.plot_sensor_signals(</span>
<span class="c1">#         ERP_config=ERP_config,</span>
<span class="c1">#         y_trials=y_noisy,</span>
<span class="c1">#         mode=&quot;stack&quot;,</span>
<span class="c1">#         channels=&quot;all&quot;,  # or &quot;all&quot;</span>
<span class="c1">#         units=sensor_simulator.sensor_units,</span>
<span class="c1">#         title=&quot;Sensor Signals (All Trials)&quot;,</span>
<span class="c1">#         save_dir=&quot;data_simulation&quot;,</span>
<span class="c1">#         file_name=&quot;sensor_all_trials_noisy&quot;,</span>
<span class="c1">#         show=False</span>
<span class="c1">#     )</span>

<span class="c1">#     # Concatenated trials: y_noisy</span>
<span class="c1">#     viz.plot_sensor_signals(</span>
<span class="c1">#         ERP_config=ERP_config,</span>
<span class="c1">#         y_trials=y_noisy,</span>
<span class="c1">#         mode=&quot;concatenate&quot;,</span>
<span class="c1">#         channels=[0, 2],  # or &quot;all&quot;</span>
<span class="c1">#         units=sensor_simulator.sensor_units,</span>
<span class="c1">#         title=&quot;Sensor Signals (Concatenated)&quot;,</span>
<span class="c1">#         save_dir=&quot;data_simulation&quot;,</span>
<span class="c1">#         file_name=&quot;sensor_concatenated_noisy&quot;,</span>
<span class="c1">#         show=False</span>
<span class="c1">#     )</span>


<span class="c1"># if __name__ == &quot;__main__&quot;:</span>
<span class="c1">#     main()</span>



<span class="c1"># ------------------------------------------------------------------</span>

<span class="c1"># visualize_leadfield_sensor_boxplot(</span>
<span class="c1">#     L,</span>
<span class="c1">#     orientation_type=self.orientation_type, </span>
<span class="c1">#     sensor_indices_to_plot=list(range(self.n_sensors)), </span>
<span class="c1">#     max_sensors_to_plot=20,</span>
<span class="c1">#     save_path=os.path.join(save_path, &quot;leadfield_sensor_boxplot.png&quot;),</span>
<span class="c1">#     show=False</span>
<span class="c1"># )</span>

<span class="c1"># visualize_leadfield_distribution(</span>
<span class="c1">#     L,</span>
<span class="c1">#     orientation_type=self.orientation_type,</span>
<span class="c1">#     bins=100,</span>
<span class="c1">#     save_path=os.path.join(save_path, &quot;leadfield_distribution.png&quot;),</span>
<span class="c1">#     show=False</span>
<span class="c1"># )</span>

<span class="c1"># visualize_leadfield(</span>
<span class="c1">#      L,</span>
<span class="c1">#      orientation_type=self.orientation_type,</span>
<span class="c1">#      save_path=os.path.join(save_path, &quot;leadfield_matrix.png&quot;),</span>
<span class="c1">#      show=False</span>
<span class="c1"># )</span>

<span class="c1"># visualize_leadfield_summary(</span>
<span class="c1">#     L,</span>
<span class="c1">#     orientation_type=self.orientation_type,</span>
<span class="c1">#     bins=100,</span>
<span class="c1">#     sensor_indices_to_plot=list(range(self.n_sensors)),</span>
<span class="c1">#     # max_sensors_to_plot=10, # Let the function select if sensor_indices_to_plot is None</span>
<span class="c1">#     save_path=os.path.join(save_path, &quot;leadfield_summary.png&quot;),</span>
<span class="c1">#     show=False</span>
<span class="c1"># )</span>

<span class="c1"># visualize_leadfield_topomap(</span>
<span class="c1">#     leadfield_matrix=L,</span>
<span class="c1">#     x=x_all_trials[first_trial_idx],</span>
<span class="c1">#     orientation_type=self.orientation_type,</span>
<span class="c1">#     title=&quot;Leadfield Topomap for Some Active (Nonzero) Sources&quot;,</span>
<span class="c1">#     save_path=os.path.join(save_path, &quot;leadfield_topomap.png&quot;),</span>
<span class="c1">#     show=False,</span>
<span class="c1"># )</span>

<span class="c1"># print(f&quot;\nPlotting results for trial {first_trial_idx + 1}...&quot;)</span>

<span class="c1"># time_vector = np.arange(self.tmin, self.tmax, 1.0 / self.sfreq)</span>

<span class="c1"># # Now plot_sensor_signals uses the clean and noisy data generated separately</span>
<span class="c1"># plot_sensor_signals( </span>
<span class="c1">#     y_clean=y_clean_all_trials[first_trial_idx], # Use stored clean data</span>
<span class="c1">#     y_noisy=y_noisy_all_trials[first_trial_idx],       # Use stored noisy data</span>
<span class="c1">#     sensor_indices=sensor_subplots_indices,</span>
<span class="c1">#     times=time_vector,</span>
<span class="c1">#     save_dir=save_path,</span>
<span class="c1">#     figure_name=f&quot;specific_sensor_signals_subplots_trial{first_trial_idx}&quot;,</span>
<span class="c1">#     trial_idx=first_trial_idx</span>
<span class="c1"># )</span>

<span class="c1"># plot_active_sources(</span>
<span class="c1">#     x=x_all_trials[first_trial_idx],</span>
<span class="c1">#     times=time_vector,</span>
<span class="c1">#     active_indices=active_indices_all_trials[first_trial_idx],</span>
<span class="c1">#     stim_onset=self.stim_onset,</span>
<span class="c1">#     nnz=self.nnz,</span>
<span class="c1">#     save_dir=save_path,</span>
<span class="c1">#     figure_name=f&quot;active_sources_subplots_trial{first_trial_idx}&quot;,</span>
<span class="c1">#     trial_idx=first_trial_idx</span>
<span class="c1"># )</span>


<span class="c1"># plot_sorted_posterior_variances(top_k=10)</span>
<span class="c1"># visualize_sorted_covariances(top_k=10)</span>
<span class="c1"># plot_posterior_covariance_matrix()</span>

<span class="c1"># ======================================================================================</span>

<span class="c1"># def visualize_leadfield_summary(</span>
<span class="c1">#     self,</span>
<span class="c1">#     leadfield_matrix: np.ndarray,</span>
<span class="c1">#     orientation_type: str = &quot;fixed&quot;,</span>
<span class="c1">#     bins: int = 100,</span>
<span class="c1">#     sensor_indices_to_plot: Optional[List[int]] = None,</span>
<span class="c1">#     max_sensors_to_plot: int = 10,</span>
<span class="c1">#     main_title: Optional[str] = None,</span>
<span class="c1">#     save_path: Optional[str] = None,</span>
<span class="c1">#     show: bool = False</span>
<span class="c1"># ) -&gt; None:</span>
<span class="c1">#     # ... (initial parameter validation and actual_sensor_indices_to_plot logic remains the same) ...</span>
<span class="c1">#     if leadfield_matrix is None or not isinstance(leadfield_matrix, np.ndarray) or leadfield_matrix.size == 0:</span>
<span class="c1">#         self.logger.error(&quot;Invalid leadfield matrix provided for summary visualization.&quot;)</span>
<span class="c1">#         return</span>

<span class="c1">#     fig = None</span>
<span class="c1">#     try:</span>
<span class="c1">#         num_total_sensors_in_lf = leadfield_matrix.shape[0]</span>
<span class="c1">#         actual_sensor_indices_to_plot: np.ndarray</span>

<span class="c1">#         if sensor_indices_to_plot is None:</span>
<span class="c1">#             if num_total_sensors_in_lf &gt; max_sensors_to_plot:</span>
<span class="c1">#                 actual_sensor_indices_to_plot = np.linspace(0, num_total_sensors_in_lf - 1, max_sensors_to_plot, dtype=int)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 actual_sensor_indices_to_plot = np.arange(num_total_sensors_in_lf)</span>
<span class="c1">#         else:</span>
<span class="c1">#             actual_sensor_indices_to_plot = np.array(sensor_indices_to_plot, dtype=int)</span>
<span class="c1">#             if np.any(actual_sensor_indices_to_plot &lt; 0) or np.any(actual_sensor_indices_to_plot &gt;= num_total_sensors_in_lf):</span>
<span class="c1">#                 self.logger.error(&quot;Summary Plot: Invalid sensor_indices_to_plot: indices out of bounds.&quot;)</span>
<span class="c1">#                 if num_total_sensors_in_lf &gt; 0 :</span>
<span class="c1">#                     actual_sensor_indices_to_plot = np.arange(min(num_total_sensors_in_lf, max_sensors_to_plot))</span>
<span class="c1">#                     self.logger.warning(f&quot;Defaulting to plotting first {len(actual_sensor_indices_to_plot)} sensors for heatmap/boxplot.&quot;)</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     actual_sensor_indices_to_plot = np.array([])</span>

<span class="c1">#         fig = plt.figure(figsize=(16, 18)) # Adjust figsize as needed</span>

<span class="c1">#         # Main GridSpec: 2 rows, 1 column. Each row will be further divided.</span>
<span class="c1">#         gs_rows = gridspec.GridSpec(2, 1, figure=fig, height_ratios=[1, 1]) # Adjust height_ratios if needed</span>

<span class="c1">#         # --- Top Row: Heatmap and its Colorbar ---</span>
<span class="c1">#         # To make the heatmap image wider, increase the first ratio (e.g., 0.95)</span>
<span class="c1">#         # and decrease the second (e.g., 0.03), ensuring they make sense for the space.</span>
<span class="c1">#         gs_top_row = gridspec.GridSpecFromSubplotSpec(1, 2, subplot_spec=gs_rows[0],</span>
<span class="c1">#                                                         width_ratios=[0.50, 0.03], # Example: Heatmap image gets 93%, colorbar 5% of top row width</span>
<span class="c1">#                                                         wspace=0.5) # Adjust space between heatmap image and its colorbar</span>
<span class="c1">#         ax_heatmap_img = fig.add_subplot(gs_top_row[0, 0])</span>
<span class="c1">#         cax_heatmap_cb = fig.add_subplot(gs_top_row[0, 1])</span>

<span class="c1">#         # --- Bottom Row: Boxplot and Histogram ---</span>
<span class="c1">#         gs_bottom_row = gridspec.GridSpecFromSubplotSpec(1, 2,</span>
<span class="c1">#                                                             subplot_spec=gs_rows[1],</span>
<span class="c1">#                                                             width_ratios=[0.75, 0.25], # Example: Boxplot 75%, histogram 25% of bottom row width</span>
<span class="c1">#                                                             wspace=0.02) # Adjust space between boxplot and histogram</span>
<span class="c1">#         ax_boxplot = fig.add_subplot(gs_bottom_row[0, 0], sharex=ax_heatmap_img) # Boxplot shares X with heatmap IMAGE</span>
<span class="c1">#         ax_hist_y = fig.add_subplot(gs_bottom_row[0, 1], sharey=ax_boxplot)  # Histogram shares Y with boxplot</span>

<span class="c1">#         if main_title is None:</span>
<span class="c1">#             default_main_title = f&quot;Leadfield Matrix Summary ({orientation_type.capitalize()} Orientation)&quot;</span>
<span class="c1">#             fig.suptitle(default_main_title, fontsize=18, y=0.99)</span>
<span class="c1">#         elif main_title:</span>
<span class="c1">#             fig.suptitle(main_title, fontsize=18, y=0.99)</span>

<span class="c1">#         # ... (rest of the plotting logic for heatmap, boxplot, histogram remains the same as the previous version) ...</span>
<span class="c1">#         # --- Prepare data for heatmap (lf_for_heatmap: sources on Y, selected sensors on X) ---</span>
<span class="c1">#         if orientation_type == &quot;fixed&quot;:</span>
<span class="c1">#             if leadfield_matrix.ndim != 2:</span>
<span class="c1">#                 raise ValueError(f&quot;Heatmap: Expected 2D leadfield for fixed, got {leadfield_matrix.ndim}D&quot;)</span>
<span class="c1">#             lf_norm_for_heatmap = leadfield_matrix</span>
<span class="c1">#             heatmap_title_suffix = &quot;(Fixed Orientation)&quot;</span>
<span class="c1">#         elif orientation_type == &quot;free&quot;:</span>
<span class="c1">#             if leadfield_matrix.ndim != 3 or leadfield_matrix.shape[-1] != 3:</span>
<span class="c1">#                 raise ValueError(f&quot;Heatmap: Expected 3D leadfield (..., 3) for free, got {leadfield_matrix.shape}&quot;)</span>
<span class="c1">#             lf_norm_for_heatmap = np.linalg.norm(leadfield_matrix, axis=-1)</span>
<span class="c1">#             heatmap_title_suffix = &quot;(Free Orientation - Norm)&quot;</span>
<span class="c1">#         else:</span>
<span class="c1">#             raise ValueError(&quot;Heatmap: Invalid orientation type.&quot;)</span>

<span class="c1">#         if len(actual_sensor_indices_to_plot) &gt; 0:</span>
<span class="c1">#             lf_selected_sensors = lf_norm_for_heatmap[actual_sensor_indices_to_plot, :]</span>
<span class="c1">#             data_for_heatmap_display = lf_selected_sensors.T</span>
<span class="c1">#         else:</span>
<span class="c1">#             data_for_heatmap_display = np.array([[]])</span>
<span class="c1">#             ax_heatmap_img.text(0.5, 0.5, &quot;No sensors for heatmap.&quot;, ha=&#39;center&#39;, va=&#39;center&#39;)</span>

<span class="c1">#         # --- Subplot 1: Flipped Leadfield Heatmap (ax_heatmap_img) &amp; Colorbar (cax_heatmap_cb) ---</span>
<span class="c1">#         if data_for_heatmap_display.size &gt; 0 :</span>
<span class="c1">#             im = ax_heatmap_img.imshow(data_for_heatmap_display, aspect=&#39;auto&#39;, cmap=&#39;viridis&#39;, interpolation=&#39;nearest&#39;)</span>
<span class="c1">#             fig.colorbar(im, cax=cax_heatmap_cb, label=f&quot;Amplitude ({self.leadfield_units})&quot;)</span>
<span class="c1">#             ax_heatmap_img.set_title(f&quot;Leadfield Matrix {heatmap_title_suffix}&quot;, fontsize=14)</span>
<span class="c1">#             ax_heatmap_img.set_ylabel(&quot;Sources&quot;, fontsize=12)</span>
<span class="c1">#             ax_heatmap_img.set_xlabel(&quot;Sensor Index&quot;, fontsize=12)</span>
<span class="c1">#         else:</span>
<span class="c1">#             ax_heatmap_img.set_title(f&quot;Leadfield Matrix {heatmap_title_suffix}&quot;, fontsize=14)</span>
<span class="c1">#             ax_heatmap_img.set_ylabel(&quot;Sources&quot;, fontsize=12)</span>
<span class="c1">#             ax_heatmap_img.set_xlabel(&quot;Sensor Index&quot;, fontsize=12) # Fallback if no data</span>

<span class="c1">#         # --- Data for Histogram (Overall Distribution) ---</span>
<span class="c1">#         leadfield_values_flat = leadfield_matrix.flatten()</span>

<span class="c1">#         # --- Subplot 2: Leadfield Sensor Box Plots (ax_boxplot) ---</span>
<span class="c1">#         labels_for_boxplot = [str(idx) for idx in actual_sensor_indices_to_plot]</span>
<span class="c1">#         all_q1_values_for_boxplot_sensors = [] </span>
<span class="c1">#         all_q2_values_for_boxplot_sensors = [] </span>
<span class="c1">#         all_min_no_outliers_per_sensor = [] # Store min (no outliers) for each sensor&#39;s boxplot data</span>
<span class="c1">#         all_max_no_outliers_per_sensor = [] # Store max (no outliers) for each sensor&#39;s boxplot data</span>

<span class="c1">#         if len(actual_sensor_indices_to_plot) &gt; 0:</span>
<span class="c1">#             data_for_boxplot = []</span>
<span class="c1">#             for sensor_idx in actual_sensor_indices_to_plot:</span>
<span class="c1">#                 current_sensor_data = None</span>
<span class="c1">#                 if orientation_type == &quot;fixed&quot;:</span>
<span class="c1">#                     current_sensor_data = leadfield_matrix[sensor_idx, :]</span>
<span class="c1">#                 elif orientation_type == &quot;free&quot;:</span>
<span class="c1">#                     sensor_values_3d = leadfield_matrix[sensor_idx, :, :]</span>
<span class="c1">#                     current_sensor_data = np.linalg.norm(sensor_values_3d, axis=-1)</span>
<span class="c1">#                 else: </span>
<span class="c1">#                     self.logger.error(f&quot;Boxplot: Invalid orientation type &#39;{orientation_type}&#39; encountered unexpectedly. Raising ValueError.&quot;)</span>
<span class="c1">#                     raise ValueError(&quot;Boxplot: Invalid orientation type.&quot;)</span>
<span class="c1">#                 data_for_boxplot.append(current_sensor_data)</span>

<span class="c1">#                 if current_sensor_data.size &gt; 0:</span>
<span class="c1">#                     all_q1_values_for_boxplot_sensors.append(np.percentile(current_sensor_data, 25))</span>
<span class="c1">#                     all_q2_values_for_boxplot_sensors.append(np.percentile(current_sensor_data, 50))</span>

<span class="c1">#                     # Calculate min/max without outliers for THIS sensor&#39;s data</span>
<span class="c1">#                     q1_sensor = np.percentile(current_sensor_data, 25)</span>
<span class="c1">#                     q3_sensor = np.percentile(current_sensor_data, 75)</span>
<span class="c1">#                     iqr_sensor = q3_sensor - q1_sensor</span>
<span class="c1">#                     lower_bound_sensor = q1_sensor - 1.5 * iqr_sensor</span>
<span class="c1">#                     upper_bound_sensor = q3_sensor + 1.5 * iqr_sensor</span>
                    
<span class="c1">#                     sensor_data_no_outliers = current_sensor_data[</span>
<span class="c1">#                         (current_sensor_data &gt;= lower_bound_sensor) &amp;</span>
<span class="c1">#                         (current_sensor_data &lt;= upper_bound_sensor)</span>
<span class="c1">#                     ]</span>
                    
<span class="c1">#                     if sensor_data_no_outliers.size &gt; 0:</span>
<span class="c1">#                         all_min_no_outliers_per_sensor.append(np.min(sensor_data_no_outliers))</span>
<span class="c1">#                         all_max_no_outliers_per_sensor.append(np.max(sensor_data_no_outliers))</span>
<span class="c1">#                     else:</span>
<span class="c1">#                         # If all data for a sensor are outliers or it&#39;s empty after filtering</span>
<span class="c1">#                         all_min_no_outliers_per_sensor.append(np.nan)</span>
<span class="c1">#                         all_max_no_outliers_per_sensor.append(np.nan)</span>
<span class="c1">#                 else: # current_sensor_data.size == 0</span>
<span class="c1">#                     all_min_no_outliers_per_sensor.append(np.nan)</span>
<span class="c1">#                     all_max_no_outliers_per_sensor.append(np.nan)</span>
            
<span class="c1">#             boxprops = dict(facecolor=&#39;skyblue&#39;, alpha=0.7, edgecolor=&#39;black&#39;)</span>
<span class="c1">#             medianprops = dict(color=&quot;navy&quot;, linewidth=1.5)</span>
            
<span class="c1">#             bp = ax_boxplot.boxplot(data_for_boxplot, patch_artist=True, labels=labels_for_boxplot,</span>
<span class="c1">#                                     boxprops=boxprops, medianprops=medianprops, vert=True)</span>
            
<span class="c1">#             ax_boxplot.set_title(&quot;Leadfield Amplitude per Sensor&quot;, fontsize=14)</span>
<span class="c1">#             ax_boxplot.set_ylabel(f&quot;Leadfield Amplitude ({self.leadfield_units})&quot;, fontsize=12)</span>
<span class="c1">#             ax_boxplot.grid(True, linestyle=&#39;--&#39;, alpha=0.6, axis=&#39;y&#39;)</span>
<span class="c1">#             ax_boxplot.set_xlabel(&quot;Selected Sensor Index&quot;, fontsize=12) # This label will be visible</span>
<span class="c1">#             plt.setp(ax_boxplot.get_xticklabels(), rotation=45, ha=&quot;right&quot; if len(labels_for_boxplot) &gt; 5 else &quot;center&quot;)</span>
<span class="c1">#         else:</span>
<span class="c1">#             ax_boxplot.text(0.5, 0.5, &quot;No sensors for boxplot.&quot;, ha=&#39;center&#39;, va=&#39;center&#39;)</span>
<span class="c1">#             ax_boxplot.set_title(&quot;Leadfield Amplitude per Sensor&quot;, fontsize=14)</span>
<span class="c1">#             ax_boxplot.set_xlabel(&quot;Selected Sensor Index&quot;, fontsize=12)</span>
<span class="c1">#             ax_boxplot.set_ylabel(f&quot;Leadfield Amplitude ({self.leadfield_units})&quot;, fontsize=12)</span>
<span class="c1">#             self.logger.info(&quot;No boxplots generated as no sensors were selected.&quot;)</span>

<span class="c1">#         # Configure shared X-axis: Heatmap image X-ticks are based on boxplot&#39;s</span>
<span class="c1">#         if len(actual_sensor_indices_to_plot) &gt; 0 and data_for_heatmap_display.size &gt; 0:</span>
<span class="c1">#             ax_heatmap_img.set_xticks(np.arange(len(actual_sensor_indices_to_plot)))</span>
<span class="c1">#             plt.setp(ax_heatmap_img.get_xticklabels(), visible=False)</span>
<span class="c1">#         # ax_heatmap_img.set_xlabel(&quot;&quot;) # This was commented out in the provided context, keeping it so</span>

<span class="c1">#         # --- Subplot 3: Rotated Histogram (ax_hist_y) ---</span>
<span class="c1">#         ax_hist_y.hist(leadfield_values_flat, bins=bins, color=&#39;lightcoral&#39;, edgecolor=&#39;black&#39;, alpha=0.7, orientation=&#39;horizontal&#39;)</span>
<span class="c1">#         ax_hist_y.set_title(&quot;Overall Distribution&quot;, fontsize=14)</span>
<span class="c1">#         ax_hist_y.set_xlabel(&quot;Frequency&quot;, fontsize=12)</span>
<span class="c1">#         plt.setp(ax_hist_y.get_yticklabels(), visible=False)</span>
<span class="c1">#         ax_hist_y.grid(True, linestyle=&#39;--&#39;, alpha=0.7, axis=&#39;x&#39;)</span>

<span class="c1">#         mean_val = np.mean(leadfield_values_flat)</span>
<span class="c1">#         median_val = np.median(leadfield_values_flat)</span>
<span class="c1">#         mean_abs_val = np.mean(np.abs(leadfield_values_flat))</span>
<span class="c1">#         std_val = np.std(leadfield_values_flat)</span>
<span class="c1">#         min_val_flat = np.min(leadfield_values_flat) # Overall min (with outliers)</span>
<span class="c1">#         max_val_flat = np.max(leadfield_values_flat) # Overall max (with outliers)</span>

<span class="c1">#         # Calculate mean of Q1 and Q2 values from the boxplot data</span>
<span class="c1">#         mean_of_boxplot_q1s = np.nanmean(all_q1_values_for_boxplot_sensors) if all_q1_values_for_boxplot_sensors else np.nan</span>
<span class="c1">#         mean_of_boxplot_q2s = np.nanmean(all_q2_values_for_boxplot_sensors) if all_q2_values_for_boxplot_sensors else np.nan</span>
        
<span class="c1">#         # Calculate mean of sensor-wise min/max (no outliers)</span>
<span class="c1">#         mean_of_sensor_mins_no_outliers = np.nanmean(all_min_no_outliers_per_sensor) if all_min_no_outliers_per_sensor else np.nan</span>
<span class="c1">#         mean_of_sensor_maxs_no_outliers = np.nanmean(all_max_no_outliers_per_sensor) if all_max_no_outliers_per_sensor else np.nan</span>
        
<span class="c1">#         self.logger.info(f&quot;Leadfield overall flat data stats: N_values={len(leadfield_values_flat)}, Mean={mean_val:.2e}, Std={std_val:.2e}, Median={median_val:.2e}, Min={min_val_flat:.2e}, Max={max_val_flat:.2e}, Mean Abs={mean_abs_val:.2e}&quot;)</span>
<span class="c1">#         self.logger.info(f&quot;Leadfield boxplot sensors stats: Mean of Q1s={mean_of_boxplot_q1s:.2e}, Mean of Q2s (Medians)={mean_of_boxplot_q2s:.2e} (for {len(all_q1_values_for_boxplot_sensors)} sensors)&quot;)</span>
<span class="c1">#         self.logger.info(f&quot;Leadfield boxplot sensors (no outliers): Mean of Mins={mean_of_sensor_mins_no_outliers:.2e}, Mean of Maxs={mean_of_sensor_maxs_no_outliers:.2e}&quot;)</span>
        
<span class="c1">#         stats_text = (f&quot;Overall Mean: {mean_val:.2e}\n&quot;</span>
<span class="c1">#                         f&quot;Overall Median: {median_val:.2e}\n&quot;</span>
<span class="c1">#                         f&quot;Overall Std: {std_val:.2e}\n&quot;</span>
<span class="c1">#                         f&quot;Overall Min: {min_val_flat:.2e}\n&quot;</span>
<span class="c1">#                         f&quot;Overall Max: {max_val_flat:.2e}\n&quot;</span>
<span class="c1">#                         f&quot;Mean Abs: {mean_abs_val:.2e}\n&quot;</span>
<span class="c1">#                         f&quot;Mean Boxplot Q1s: {mean_of_boxplot_q1s:.2e}\n&quot;</span>
<span class="c1">#                         f&quot;Mean Boxplot Q2s: {mean_of_boxplot_q2s:.2e}\n&quot;</span>
<span class="c1">#                         f&quot;Mean Sensor Min (no outliers): {mean_of_sensor_mins_no_outliers:.2e}\n&quot;</span>
<span class="c1">#                         f&quot;Mean Sensor Max (no outliers): {mean_of_sensor_maxs_no_outliers:.2e}&quot;)</span>
        
<span class="c1">#         ax_hist_y.text(0.95, 0.95, stats_text, transform=ax_hist_y.transAxes, fontsize=9,verticalalignment=&#39;top&#39;, horizontalalignment=&#39;right&#39;, bbox=dict(boxstyle=&#39;round,pad=0.3&#39;, fc=&#39;wheat&#39;, alpha=0.5))</span>

        
<span class="c1">#         fig.tight_layout(rect=[0, 0, 1, 0.97] if main_title else [0,0,1,1])</span>

<span class="c1">#         if save_path:</span>
<span class="c1">#             save_dir = Path(save_path).parent</span>
<span class="c1">#             save_dir.mkdir(parents=True, exist_ok=True)</span>
<span class="c1">#             plt.savefig(save_path, bbox_inches=&quot;tight&quot;, dpi=150)</span>
<span class="c1">#             self.logger.info(f&quot;Leadfield summary visualization saved to {save_path}&quot;)</span>
<span class="c1">#         if show:</span>
<span class="c1">#             plt.show()</span>

<span class="c1">#     except Exception as e:</span>
<span class="c1">#             self.logger.error(f&quot;Failed during leadfield summary visualization: {e}&quot;, exc_info=True)</span>
<span class="c1">#     finally:</span>
<span class="c1">#             if fig:</span>
<span class="c1">#                 plt.close(fig)</span>
                                    
<span class="c1"># def visualize_leadfield_topomap(</span>
<span class="c1">#     self,</span>
<span class="c1">#     leadfield_matrix: np.ndarray,</span>
<span class="c1">#     x: np.ndarray,</span>
<span class="c1">#     info: mne.Info=None,</span>
<span class="c1">#     orientation_type: str = &quot;fixed&quot;,</span>
<span class="c1">#     save_path: Optional[str] = None,</span>
<span class="c1">#     title: Optional[str] = None,</span>
<span class="c1">#     show: bool = False</span>
<span class="c1"># ) -&gt; None:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Visualize leadfield patterns as topomaps for active sources.</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     leadfield_matrix : np.ndarray</span>
<span class="c1">#         The leadfield matrix.</span>
<span class="c1">#         - &#39;fixed&#39;: Shape (n_sensors, n_sources).</span>
<span class="c1">#         - &#39;free&#39;: Shape (n_sensors, n_sources, 3).</span>
<span class="c1">#     info : mne.Info</span>
<span class="c1">#         MNE info object containing sensor locations.</span>
<span class="c1">#     x : np.ndarray</span>
<span class="c1">#         Source activity matrix to determine active sources.</span>
<span class="c1">#         - &#39;fixed&#39;: Shape (n_sources, n_times).</span>
<span class="c1">#         - &#39;free&#39;: Shape (n_sources, 3, n_times).</span>
<span class="c1">#     orientation_type : str, optional</span>
<span class="c1">#         Orientation type (&#39;fixed&#39; or &#39;free&#39;), by default &quot;fixed&quot;.</span>
<span class="c1">#     save_path : Optional[str], optional</span>
<span class="c1">#         Path to save the figure. If None, not saved, by default None.</span>
<span class="c1">#     title : Optional[str], optional</span>
<span class="c1">#         Title for the entire figure, by default None.</span>
<span class="c1">#     show : bool, optional</span>
<span class="c1">#         If True, display the plot, by default False.</span>

<span class="c1">#     Raises</span>
<span class="c1">#     ------</span>
<span class="c1">#     ValueError</span>
<span class="c1">#         If inputs are invalid or orientation_type is unsupported.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     try:</span>
<span class="c1">#         if self.channel_type == &quot;eeg&quot;:</span>
<span class="c1">#             ch_types = [&quot;eeg&quot;] * self.n_sensors</span>
<span class="c1">#         elif self.channel_type == &quot;meg&quot;:</span>
<span class="c1">#             ch_types = [&quot;grad&quot;] * self.n_sensors  # or &quot;mag&quot; if you want magnetometers</span>
<span class="c1">#         else:</span>
<span class="c1">#             raise ValueError(f&quot;Unsupported channel_type: {self.channel_type}&quot;)</span>

<span class="c1">#         info = mne.create_info(</span>
<span class="c1">#             ch_names=[f&quot;{self.channel_type}{i:03}&quot; for i in range(self.n_sensors)],</span>
<span class="c1">#             sfreq=self.sfreq,</span>
<span class="c1">#             ch_types=ch_types,</span>
<span class="c1">#         )</span>
        
<span class="c1">#     except Exception as e:</span>
<span class="c1">#         self.logger.error(f&quot;Failed to create MNE info: {e}&quot;)</span>
<span class="c1">#         info = None</span>
        
<span class="c1">#     if leadfield_matrix is None or not isinstance(leadfield_matrix, np.ndarray) or leadfield_matrix.size == 0:</span>
<span class="c1">#         self.logger.error(&quot;Invalid leadfield matrix provided for topomap visualization.&quot;)</span>
<span class="c1">#         return</span>
<span class="c1">#     if x is None or not isinstance(x, np.ndarray) or x.size == 0:</span>
<span class="c1">#         self.logger.error(&quot;Invalid source activity matrix provided for topomap visualization.&quot;)</span>
<span class="c1">#         return</span>
<span class="c1">#     if info is None or not isinstance(info, mne.Info):</span>
<span class="c1">#             self.logger.error(&quot;Invalid MNE info object provided for topomap visualization.&quot;)</span>
<span class="c1">#             return</span>

<span class="c1">#     fig = None # Initialize fig</span>
<span class="c1">#     try:</span>
<span class="c1">#         if orientation_type == &quot;fixed&quot;:</span>
<span class="c1">#             if leadfield_matrix.ndim != 2:</span>
<span class="c1">#                     raise ValueError(f&quot;Expected 2D leadfield for fixed orientation, got {leadfield_matrix.ndim}D&quot;)</span>
<span class="c1">#             active_sources = np.where(np.any(x != 0, axis=-1))[0]</span>
<span class="c1">#         elif orientation_type == &quot;free&quot;:</span>
<span class="c1">#             if leadfield_matrix.ndim != 3 or leadfield_matrix.shape[-1] != 3:</span>
<span class="c1">#                     raise ValueError(f&quot;Expected 3D leadfield (..., 3) for free orientation, got shape {leadfield_matrix.shape}&quot;)</span>
<span class="c1">#             self.logger.info(&quot;Calculating norm of source activity to find active sources for free orientation.&quot;)</span>
<span class="c1">#             active_sources = np.where(np.any(x != 0, axis=(1, 2)))[0]</span>
<span class="c1">#         else:</span>
<span class="c1">#             raise ValueError(&quot;Invalid orientation type. Must be &#39;fixed&#39; or &#39;free&#39;.&quot;)</span>

<span class="c1">#         if len(active_sources) == 0:</span>
<span class="c1">#                 self.logger.warning(&quot;No active sources found to visualize topomaps.&quot;)</span>
<span class="c1">#                 return</span>

<span class="c1">#         n_active = len(active_sources)</span>
<span class="c1">#         n_cols = min(5, n_active) # Max 5 columns</span>
<span class="c1">#         n_rows = int(np.ceil(n_active / n_cols))</span>
<span class="c1">#         fig, axes = plt.subplots(n_rows, n_cols, figsize=(n_cols * 3, n_rows * 3), squeeze=False)</span>
<span class="c1">#         axes_flat = axes.flatten()</span>

<span class="c1">#         # Determine global color limits for consistency</span>
<span class="c1">#         all_leadfield_values = []</span>
<span class="c1">#         for i, source_idx in enumerate(active_sources):</span>
<span class="c1">#             if orientation_type == &quot;fixed&quot;:</span>
<span class="c1">#                 leadfield_values = leadfield_matrix[:, source_idx]</span>
<span class="c1">#             else: # free</span>
<span class="c1">#                 # Visualize the norm of the 3 components for simplicity</span>
<span class="c1">#                 leadfield_values = np.linalg.norm(leadfield_matrix[:, source_idx, :], axis=-1)</span>
<span class="c1">#             all_leadfield_values.append(leadfield_values)</span>

<span class="c1">#         if not all_leadfield_values:</span>
<span class="c1">#                 self.logger.warning(&quot;Could not extract leadfield values for any active source.&quot;)</span>
<span class="c1">#                 return</span>

<span class="c1">#         vmax = np.max(all_leadfield_values)</span>
<span class="c1">#         vmin = np.min(all_leadfield_values)</span>

<span class="c1">#         for i, source_idx in enumerate(active_sources):</span>
<span class="c1">#             leadfield_values = all_leadfield_values[i]</span>
<span class="c1">#             im, _ = mne.viz.plot_topomap(</span>
<span class="c1">#                 leadfield_values, info, axes=axes_flat[i], cmap=&quot;RdBu_r&quot;, # Use diverging colormap</span>
<span class="c1">#                 # vlim=(vmin, vmax), </span>
<span class="c1">#                 show=False,</span>
<span class="c1">#                 contours=6</span>
<span class="c1">#             )</span>
<span class="c1">#             axes_flat[i].set_title(f&quot;Source {source_idx}&quot;)</span>

<span class="c1">#         # Add a single colorbar</span>
<span class="c1">#         fig.colorbar(im, ax=axes.ravel().tolist(), label=f&#39;Leadfield Amplitude ({self.leadfield_units})&#39;, shrink=0.6, aspect=10)</span>

<span class="c1">#         # Hide unused subplots</span>
<span class="c1">#         for j in range(n_active, len(axes_flat)):</span>
<span class="c1">#             axes_flat[j].axis(&quot;off&quot;)</span>

<span class="c1">#         if title:</span>
<span class="c1">#             fig.suptitle(title, fontsize=16) # Removed weight=&quot;bold&quot;</span>

<span class="c1">#         # plt.tight_layout(rect=[0, 0, 1, 0.95] if title else [0, 0, 1, 1])</span>

<span class="c1">#         if save_path:</span>
<span class="c1">#             save_dir = Path(save_path).parent</span>
<span class="c1">#             save_dir.mkdir(parents=True, exist_ok=True)</span>
<span class="c1">#             plt.savefig(save_path, bbox_inches=&quot;tight&quot;)</span>
<span class="c1">#             self.logger.info(f&quot;Leadfield topomap visualization saved to {save_path}&quot;)</span>

<span class="c1">#         if show:</span>
<span class="c1">#             plt.show()</span>

<span class="c1">#     except Exception as e:</span>
<span class="c1">#             self.logger.error(f&quot;Failed during leadfield topomap visualization: {e}&quot;)</span>
<span class="c1">#     finally:</span>
<span class="c1">#             if fig:</span>
<span class="c1">#                 plt.close(fig)</span>
            
<span class="c1"># def inspect_matrix_values(self, matrix, matrix_name=&quot;Matrix&quot;):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Prints summary statistics and checks for invalid values in a NumPy array.</span>

<span class="c1">#     Parameters:</span>
<span class="c1">#     - matrix (np.ndarray): The matrix to inspect.</span>
<span class="c1">#     - matrix_name (str): A name for the matrix used in print statements.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     print(f&quot;--- Inspecting {matrix_name} Values ---&quot;)</span>
<span class="c1">#     if not isinstance(matrix, np.ndarray):</span>
<span class="c1">#         print(f&quot;Error: Input is not a NumPy array.&quot;)</span>
<span class="c1">#         return</span>
<span class="c1">#     if matrix.size == 0:</span>
<span class="c1">#         print(f&quot;Warning: {matrix_name} is empty.&quot;)</span>
<span class="c1">#         return</span>

<span class="c1">#     try:</span>
<span class="c1">#         min_val = np.min(matrix)</span>
<span class="c1">#         max_val = np.max(matrix)</span>
<span class="c1">#         mean_val = np.mean(matrix)</span>
<span class="c1">#         mean_abs_val = np.mean(np.abs(matrix))</span>
<span class="c1">#         std_val = np.std(matrix)</span>

<span class="c1">#         print(f&quot;{matrix_name} mean: {mean_val:.2e}, std: {std_val:.2e}&quot;)</span>
<span class="c1">#         print(f&quot;{matrix_name} min: {min_val:.2e}, max: {max_val:.2e}&quot;)</span>
<span class="c1">#         # print(f&quot;{matrix_name} std: {std_val:.1e}&quot;) # Redundant with first line</span>
<span class="c1">#         print(f&quot;{matrix_name} mean abs: {mean_abs_val:.2e}&quot;)</span>

<span class="c1">#         nan_check = np.isnan(matrix).any()</span>
<span class="c1">#         inf_check = np.isinf(matrix).any()</span>

<span class="c1">#         if nan_check:</span>
<span class="c1">#             print(f&quot;WARNING: {matrix_name} contains NaN values!&quot;)</span>
<span class="c1">#         if inf_check:</span>
<span class="c1">#             print(f&quot;WARNING: {matrix_name} contains Inf values!&quot;)</span>
<span class="c1">#         if not nan_check and not inf_check:</span>
<span class="c1">#             print(f&quot;{matrix_name} contains valid numbers (no NaNs or Infs detected).&quot;)</span>

<span class="c1">#     except Exception as e:</span>
<span class="c1">#         print(f&quot;Error during inspection of {matrix_name}: {e}&quot;)</span>
<span class="c1">#     print(f&quot;--- End {matrix_name} Inspection ---&quot;)</span>

<span class="c1"># def load_and_validate_leadfield(self, leadfield_file_path, orientation_type):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Loads a leadfield matrix from an .npz file and validates its shape</span>
<span class="c1">#     based on the expected orientation type. Includes value inspection.</span>

<span class="c1">#     Parameters:</span>
<span class="c1">#     - leadfield_file_path (str or Path): Path to the .npz file containing the leadfield.</span>
<span class="c1">#     - orientation_type (str): The expected orientation type (&quot;fixed&quot; or &quot;free&quot;).</span>

<span class="c1">#     Returns:</span>
<span class="c1">#     - np.ndarray: The loaded and validated leadfield matrix.</span>

<span class="c1">#     Raises:</span>
<span class="c1">#     - FileNotFoundError: If the leadfield file does not exist.</span>
<span class="c1">#     - KeyError: If the expected key is not found in the .npz file.</span>
<span class="c1">#     - ValueError: If the loaded leadfield matrix shape is inconsistent with the orientation_type.</span>
<span class="c1">#     - Exception: For other potential loading errors.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     print(f&quot;Loading leadfield from: {leadfield_file_path}&quot;)</span>
<span class="c1">#     try:</span>
<span class="c1">#         with np.load(leadfield_file_path) as data:</span>
<span class="c1">#             # ... (loading logic as before) ...</span>
<span class="c1">#             if &#39;lead_field&#39; in data:</span>
<span class="c1">#                 leadfield_matrix = data[&quot;lead_field&quot;]</span>
<span class="c1">#             elif &#39;lead_field_fixed&#39; in data and orientation_type == &quot;fixed&quot;:</span>
<span class="c1">#                 leadfield_matrix = data[&#39;lead_field_fixed&#39;]</span>
<span class="c1">#             elif &#39;lead_field_free&#39; in data and orientation_type == &quot;free&quot;:</span>
<span class="c1">#                 leadfield_matrix = data[&#39;lead_field_free&#39;]</span>
<span class="c1">#             elif &#39;lead_field&#39; in data:</span>
<span class="c1">#                 print(&quot;Warning: Loading generic &#39;lead_field&#39; key. Ensure it matches orientation type.&quot;)</span>
<span class="c1">#                 leadfield_matrix = data[&quot;lead_field&quot;]</span>
<span class="c1">#             else:</span>
<span class="c1">#                 keys_found = list(data.keys())</span>
<span class="c1">#                 raise KeyError(f&quot;Could not find a suitable leadfield key (&#39;lead_field&#39;, &#39;lead_field_fixed&#39;, &#39;lead_field_free&#39;) in .npz file. Found keys: {keys_found}&quot;)</span>

<span class="c1">#         print(f&quot;Leadfield loaded successfully. Initial Shape: {leadfield_matrix.shape}&quot;, &quot;dtype:&quot;, leadfield_matrix.dtype)</span>

<span class="c1">#         # --- Validate leadfield shape against orientation_type ---</span>
<span class="c1">#         # ... (validation logic as before) ...</span>
<span class="c1">#         if orientation_type == &quot;fixed&quot;:</span>
<span class="c1">#             if leadfield_matrix.ndim != 2:</span>
<span class="c1">#                 raise ValueError(f&quot;Expected 2D leadfield for fixed orientation, got shape {leadfield_matrix.shape}&quot;)</span>
<span class="c1">#         elif orientation_type == &quot;free&quot;:</span>
<span class="c1">#             if leadfield_matrix.ndim == 3:</span>
<span class="c1">#                 if leadfield_matrix.shape[2] != 3:</span>
<span class="c1">#                     raise ValueError(f&quot;Expected 3 components in last dimension for free orientation, got shape {leadfield_matrix.shape}&quot;)</span>
<span class="c1">#             elif leadfield_matrix.ndim == 2:</span>
<span class="c1">#                 if leadfield_matrix.shape[1] % 3 == 0:</span>
<span class="c1">#                     print(&quot;Warning: Reshaping potentially flattened free orientation leadfield.&quot;)</span>
<span class="c1">#                     n_sensors, n_sources_x_3 = leadfield_matrix.shape</span>
<span class="c1">#                     n_sources = n_sources_x_3 // 3</span>
<span class="c1">#                     leadfield_matrix = leadfield_matrix.reshape(n_sensors, n_sources, 3)</span>
<span class="c1">#                     print(f&quot;Reshaped leadfield to {leadfield_matrix.shape}&quot;)</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     raise ValueError(f&quot;Cannot reshape 2D leadfield (shape {leadfield_matrix.shape}) to 3D free orientation.&quot;)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 raise ValueError(f&quot;Expected 2D or 3D leadfield for free orientation, got {leadfield_matrix.ndim} dimensions with shape {leadfield_matrix.shape}&quot;)</span>
<span class="c1">#         else:</span>
<span class="c1">#             raise ValueError(f&quot;Invalid orientation_type specified: {orientation_type}. Choose &#39;fixed&#39; or &#39;free&#39;.&quot;)</span>


<span class="c1">#         print(f&quot;Leadfield validated successfully. Final Shape: {leadfield_matrix.shape}&quot;)</span>

<span class="c1">#         # --- Inspect Leadfield Matrix Values using the function ---</span>
<span class="c1">#         self.inspect_matrix_values(leadfield_matrix, matrix_name=&quot;Leadfield&quot;)</span>
<span class="c1">#         # --- End Inspection ---</span>

<span class="c1">#         return leadfield_matrix</span>

<span class="c1">#     except FileNotFoundError:</span>
<span class="c1">#         print(f&quot;Error: Leadfield file not found at {leadfield_file_path}&quot;)</span>
<span class="c1">#         raise # Re-raise the exception</span>
<span class="c1">#     except (KeyError, ValueError) as e:</span>
<span class="c1">#         print(f&quot;Error loading or validating leadfield: {e}&quot;)</span>
<span class="c1">#         raise # Re-raise the specific error</span>
<span class="c1">#     except Exception as e:</span>
<span class="c1">#         print(f&quot;An unexpected error occurred during leadfield loading: {e}&quot;)</span>
<span class="c1">#         raise </span>

<span class="c1"># # --- Plotting Functions ---</span>
<span class="c1"># def plot_sensor_signals(self, y_clean, y_noisy, sensor_indices=None, times=None, save_dir=None, figure_name=None, trial_idx=None):</span>
<span class="c1">#     &quot;&quot;&quot; Plot clean and noisy sensor signals for specific sensors for a specific trial. &quot;&quot;&quot;</span>
<span class="c1">#     if sensor_indices is None:</span>
<span class="c1">#         sensor_indices = [0]</span>
<span class="c1">#     if times is None:</span>
<span class="c1">#         times = np.arange(y_clean.shape[1])</span>

<span class="c1">#     n_sensors_to_plot = len(sensor_indices)</span>
<span class="c1">#     fig, axes = plt.subplots(n_sensors_to_plot, 1, figsize=(10, n_sensors_to_plot * 3), sharex=True, sharey=True)</span>
<span class="c1">#     title_suffix = f&quot; (Trial {trial_idx+1})&quot; if trial_idx is not None else &quot;&quot;</span>
<span class="c1">#     fig.suptitle(f&quot;Specific Sensor Signals{title_suffix}&quot;, fontsize=16)</span>

<span class="c1">#     if n_sensors_to_plot == 1:</span>
<span class="c1">#         axes = [axes]</span>

<span class="c1">#     for i, sensor_idx in enumerate(sensor_indices):</span>
<span class="c1">#         axes[i].plot(times, y_clean[sensor_idx], label=&quot;y_clean&quot;, linewidth=2)</span>
<span class="c1">#         axes[i].plot(times, y_noisy[sensor_idx], label=&quot;y_noise&quot;)</span>
<span class="c1">#         axes[i].set_title(f&quot;Sensor {sensor_idx}&quot;)</span>
<span class="c1">#         axes[i].set_xlabel(&quot;Time (s)&quot;)</span>
<span class="c1">#         axes[i].set_ylabel(f&quot;Amplitude  ({self.sensor_units})&quot;)</span>
<span class="c1">#         axes[i].legend()</span>
<span class="c1">#         axes[i].grid(True)</span>

<span class="c1">#     plt.tight_layout(rect=[0, 0, 1, 0.95])</span>

<span class="c1">#     if save_dir and figure_name:</span>
<span class="c1">#         output_dir = Path(save_dir)</span>
<span class="c1">#         output_dir.mkdir(parents=True, exist_ok=True)</span>
<span class="c1">#         save_path = output_dir / f&quot;{figure_name}.png&quot;</span>
<span class="c1">#         plt.savefig(save_path, dpi=300)</span>
<span class="c1">#         print(f&quot;Sensor subplots figure saved to {save_path}&quot;)</span>
    
<span class="c1">#     plt.close(fig)</span>

<span class="c1"># def plot_all_active_sources_single_figure(self, x, times, active_indices, stim_onset, save_dir=None, figure_name=None, trial_idx=None):</span>
<span class="c1">#     &quot;&quot;&quot; Plot all specified active source signals on a single figure for a specific trial. &quot;&quot;&quot;</span>
<span class="c1">#     fig, ax = plt.subplots(1, 1, figsize=(12, 6))</span>
<span class="c1">#     title_suffix = f&quot; (Trial {trial_idx+1})&quot; if trial_idx is not None else &quot;&quot;</span>
<span class="c1">#     fig.suptitle(f&quot;All Active Source Signals{title_suffix}&quot;, fontsize=16)</span>
<span class="c1">#     colors = cm.viridis(np.linspace(0, 1, len(active_indices)))</span>

<span class="c1">#     # Handle potential free orientation source data shape</span>
<span class="c1">#     if x.ndim == 3:</span>
<span class="c1">#         x_plot = np.linalg.norm(x, axis=1) # Plot magnitude</span>
<span class="c1">#     else:</span>
<span class="c1">#         x_plot = x</span>

<span class="c1">#     for i, src_idx in enumerate(active_indices):</span>
<span class="c1">#         ax.plot(times, x_plot[src_idx], label=f&quot;Source {src_idx}&quot;, linewidth=1.5, color=colors[i])</span>

<span class="c1">#     ax.axvline(x=stim_onset, linestyle=&quot;--&quot;, color=&quot;gray&quot;, label=&quot;Stimulus Onset&quot;)</span>
<span class="c1">#     ax.set_xlabel(&quot;Time (s)&quot;)</span>
<span class="c1">#     ax.set_ylabel(f&quot;Amplitude ({self.source_units})&quot;)</span>
<span class="c1">#     ax.legend(loc=&#39;best&#39;, fontsize=&#39;small&#39;)</span>
<span class="c1">#     ax.grid(True, alpha=0.6)</span>
<span class="c1">#     ax.set_title(&quot;Active Sources&quot;)</span>
<span class="c1">#     plt.tight_layout(rect=[0, 0.03, 1, 0.95])</span>

<span class="c1">#     if save_dir and figure_name:</span>
<span class="c1">#         output_dir = Path(save_dir)</span>
<span class="c1">#         output_dir.mkdir(parents=True, exist_ok=True)</span>
<span class="c1">#         save_path = output_dir / f&quot;{figure_name}.png&quot;</span>
<span class="c1">#         plt.savefig(save_path, dpi=300)</span>
<span class="c1">#         print(f&quot;Single figure source plot saved to {save_path}&quot;)</span>
<span class="c1">#     plt.close(fig)</span>

<span class="c1"># def plot_all_sensor_signals_single_figure(self, y_data, times, sensor_indices=None, save_dir=None, figure_name=None, trial_idx=None, average_epochs=False):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Plot sensor signals (overlay) for selected sensors.</span>
<span class="c1">#     If average_epochs is True and y_data is 3D, plots the average across epochs for each channel.</span>
<span class="c1">#     If average_epochs is False and y_data is 2D, plots the single trial data.</span>
<span class="c1">#     Does NOT average across channels.</span>

<span class="c1">#     Parameters:</span>
<span class="c1">#     - y_data (np.ndarray): Sensor measurements. Can be 2D (n_channels, n_times) for a single trial</span>
<span class="c1">#                         or 3D (n_trials, n_channels, n_times) for multiple trials.</span>
<span class="c1">#     - times (np.ndarray): Time vector corresponding to the signals.</span>
<span class="c1">#     - sensor_indices (list or np.ndarray, optional): Indices of sensors to plot. If None, plots all sensors.</span>
<span class="c1">#     - save_dir (str or Path, optional): Directory to save the figure.</span>
<span class="c1">#     - figure_name (str, optional): Name of the figure file (without extension).</span>
<span class="c1">#     - trial_idx (int, optional): Index of the trial being plotted (used for title if y_data is 2D and average_epochs is False).</span>
<span class="c1">#     - average_epochs (bool): If True and y_data is 3D, plot the average across trials.</span>
<span class="c1">#                             If False and y_data is 3D, raises an error.</span>
<span class="c1">#                             If y_data is 2D, this primarily affects the title.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     fig, ax = plt.subplots(1, 1, figsize=(12, 6))</span>

<span class="c1">#     title_suffix = &quot;&quot;</span>
<span class="c1">#     plot_individual_epochs = False # Flag to control plotting individual trials (currently always False)</span>

<span class="c1">#     if y_data.ndim == 2: # Input is single trial or already averaged data</span>
<span class="c1">#         y_plot = y_data # This is the data to plot (n_channels, n_times)</span>
<span class="c1">#         if not average_epochs and trial_idx is not None:</span>
<span class="c1">#             title_suffix = f&quot; (Trial {trial_idx+1})&quot;</span>
<span class="c1">#         elif average_epochs: # Assume 2D input might be an average if flag is set</span>
<span class="c1">#             title_suffix = &quot; (Average across Trials)&quot;</span>
<span class="c1">#         # If 2D and not average_epochs and no trial_idx, title is generic</span>
<span class="c1">#     elif y_data.ndim == 3: # Input is multi-trial data</span>
<span class="c1">#         if average_epochs:</span>
<span class="c1">#             y_plot = np.mean(y_data, axis=0) # Calculate average across trials (axis 0) -&gt; shape (n_channels, n_times)</span>
<span class="c1">#             title_suffix = &quot; (Average across Trials)&quot;</span>
<span class="c1">#             # Do not plot individual epochs if averaging is requested</span>
<span class="c1">#             plot_individual_epochs = False</span>
<span class="c1">#         else:</span>
<span class="c1">#             # If 3D data is passed but averaging is not requested, it&#39;s ambiguous.</span>
<span class="c1">#             raise ValueError(&quot;Input y_data is 3D, but average_epochs is False. &quot;</span>
<span class="c1">#                             &quot;Provide 2D data (single trial) or set average_epochs=True.&quot;)</span>
<span class="c1">#     else:</span>
<span class="c1">#         raise ValueError(&quot;Input y_data must be 2D or 3D&quot;)</span>

<span class="c1">#     # Select specific sensors if requested from the data to be plotted (y_plot)</span>
<span class="c1">#     if sensor_indices is None:</span>
<span class="c1">#         sensor_indices_to_plot = np.arange(y_plot.shape[0]) # Use all channels</span>
<span class="c1">#         y_plot_selected = y_plot</span>
<span class="c1">#     else:</span>
<span class="c1">#         # Ensure indices are valid for the potentially averaged data</span>
<span class="c1">#         sensor_indices_to_plot = np.array(sensor_indices)[np.array(sensor_indices) &lt; y_plot.shape[0]]</span>
<span class="c1">#         if len(sensor_indices_to_plot) != len(sensor_indices):</span>
<span class="c1">#             print(&quot;Warning: Some requested sensor_indices are out of bounds for the provided data.&quot;)</span>
<span class="c1">#         y_plot_selected = y_plot[sensor_indices_to_plot, :]</span>

<span class="c1">#     n_plot_sensors = y_plot_selected.shape[0]</span>

<span class="c1">#     fig.suptitle(f&quot;Sensor Signals {title_suffix}&quot;, fontsize=16)</span>
<span class="c1">#     colors = cm.turbo(np.linspace(0, 1, n_plot_sensors))</span>

<span class="c1">#     # --- Plotting Logic ---</span>
<span class="c1">#     # Plot the main traces (either single trial or trial-averaged)</span>
<span class="c1">#     for i in range(n_plot_sensors):</span>
<span class="c1">#         actual_sensor_idx = sensor_indices_to_plot[i] # Get original index</span>
<span class="c1">#         ax.plot(times, y_plot_selected[i, :], linewidth=1.0, color=colors[i], alpha=0.8, label=f&quot;Ch {actual_sensor_idx}&quot; if n_plot_sensors &lt;= 15 else None)</span>

<span class="c1">#     # Optional: Plot individual epoch traces lightly in the background (currently disabled)</span>
<span class="c1">#     if plot_individual_epochs and y_data.ndim == 3:</span>
<span class="c1">#         y_plot_all_selected = y_data[:, sensor_indices_to_plot, :] # Select sensors from original 3D data</span>
<span class="c1">#         for i_trial in range(y_data.shape[0]):</span>
<span class="c1">#             for i_ch in range(n_plot_sensors):</span>
<span class="c1">#                 ax.plot(times, y_plot_all_selected[i_trial, i_ch, :], linewidth=0.2, color=colors[i_ch], alpha=0.1)</span>


<span class="c1">#     ax.set_xlabel(&quot;Time (s)&quot;)</span>
<span class="c1">#     ax.set_ylabel(f&quot;Amplitude ({self.sensor_units})&quot;)</span>
<span class="c1">#     ax.grid(True, alpha=0.6)</span>
<span class="c1">#     ax.set_title(f&quot;{n_plot_sensors} channels&quot;)</span>

<span class="c1">#     # Update legend</span>
<span class="c1">#     if n_plot_sensors &lt;= 15: # Show legend only for fewer channels</span>
<span class="c1">#         ax.legend(loc=&#39;best&#39;, fontsize=&#39;small&#39;)</span>

<span class="c1">#     plt.tight_layout(rect=[0, 0.03, 1, 0.95])</span>

<span class="c1">#     if save_dir and figure_name:</span>
<span class="c1">#         output_dir = Path(save_dir)</span>
<span class="c1">#         output_dir.mkdir(parents=True, exist_ok=True)</span>
<span class="c1">#         save_path = output_dir / f&quot;{figure_name}.png&quot;</span>
<span class="c1">#         plt.savefig(save_path, dpi=300)</span>
<span class="c1">#     plt.close(fig)</span>

<span class="c1"># def plot_active_sources(self, x, times, active_indices, stim_onset, nnz, save_dir=None, figure_name=None, trial_idx=None):</span>
<span class="c1">#     &quot;&quot;&quot; Plot active sources for a specific trial. &quot;&quot;&quot;</span>
<span class="c1">#     n_cols = 3</span>
<span class="c1">#     n_rows = int(np.ceil(nnz / n_cols))</span>
<span class="c1">#     fig, axes = plt.subplots(n_rows, n_cols, figsize=(n_cols * 5, n_rows * 4), constrained_layout=True, sharex=True, sharey=True)</span>
<span class="c1">#     title_suffix = f&quot; (Trial {trial_idx+1})&quot; if trial_idx is not None else &quot;&quot;</span>
<span class="c1">#     fig.suptitle(f&quot;Active Source Signals{title_suffix}&quot;, fontsize=16)</span>
<span class="c1">#     axes = axes.flatten()</span>

<span class="c1">#     # Handle potential free orientation source data shape (n_sources, n_orient, n_times)</span>
<span class="c1">#     # Plot the norm or the first component for simplicity</span>
<span class="c1">#     if x.ndim == 3:</span>
<span class="c1">#         x_plot = np.linalg.norm(x, axis=1) # Plot magnitude for free orientation</span>
<span class="c1">#         # Or plot first component: x_plot = x[:, 0, :]</span>
<span class="c1">#     else:</span>
<span class="c1">#         x_plot = x</span>

<span class="c1">#     for i, src_idx in enumerate(active_indices):</span>
<span class="c1">#         axes[i].plot(times, x_plot[src_idx], label=f&quot;Source {src_idx}&quot;, linewidth=2)</span>
<span class="c1">#         axes[i].axvline(x=stim_onset, linestyle=&quot;--&quot;, color=&quot;gray&quot;, label=&quot;Stimulus Onset&quot;)</span>
<span class="c1">#         axes[i].set_xlabel(&quot;Time (s)&quot;)</span>
<span class="c1">#         axes[i].set_ylabel(f&quot;Amplitude ({self.source_units})&quot;)</span>
<span class="c1">#         axes[i].set_title(f&quot;Active Source {src_idx}&quot;)</span>
<span class="c1">#         axes[i].legend()</span>
<span class="c1">#         axes[i].grid(True)</span>

<span class="c1">#     for j in range(i + 1, len(axes)):</span>
<span class="c1">#         axes[j].axis(&quot;off&quot;)</span>

<span class="c1">#     if save_dir and figure_name:</span>
<span class="c1">#         output_dir = Path(save_dir)</span>
<span class="c1">#         output_dir.mkdir(parents=True, exist_ok=True)</span>
<span class="c1">#         save_path = output_dir / f&quot;{figure_name}.png&quot;</span>
<span class="c1">#         plt.savefig(save_path, dpi=300)</span>
<span class="c1">#         print(f&quot;Subplots figure saved to {save_path}&quot;)</span>
<span class="c1">#     plt.close(fig)</span>



<span class="c1"># # ========================== from uncertainty_estimation.py =========================</span>

<span class="c1">#     def plot_sorted_posterior_variances(self, top_k=None):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Plot the sorted variances from the covariance matrix, highlighting the top-k variances.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         variances = np.diag(self.posterior_cov)</span>
<span class="c1">#         sorted_indices = np.argsort(variances)[::-1]</span>
<span class="c1">#         sorted_variances = variances[sorted_indices]</span>

<span class="c1">#         plt.figure(figsize=(12, 6))</span>
<span class="c1">#         bars = plt.bar(range(len(sorted_variances)), sorted_variances, color=&#39;skyblue&#39;, edgecolor=&#39;blue&#39;)</span>

<span class="c1">#         if top_k is not None:</span>
<span class="c1">#             for bar in bars[:top_k]:</span>
<span class="c1">#                 bar.set_color(&#39;orange&#39;)</span>

<span class="c1">#         plt.xlabel(&quot;Source Index&quot;)</span>
<span class="c1">#         plt.ylabel(&quot;Variance&quot;)</span>
<span class="c1">#         plt.title(f&quot;Sorted Posterior Variances (Top-{top_k if top_k else len(variances)} Highlighted)&quot;)</span>
<span class="c1">#         plt.grid(axis=&#39;y&#39;, linestyle=&#39;--&#39;, alpha=0.7)</span>
<span class="c1">#         plt.tight_layout(rect=[0, 0.05, 1, 0.96])</span>
<span class="c1">#         plt.savefig(os.path.join(self.experiment_dir, &#39;sorted_variances.png&#39;))</span>
<span class="c1">#         plt.close()</span>

<span class="c1">#     def _plot_confidence_ellipse(self, mean, width, height, angle, ax=None, **kwargs):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Plot a confidence ellipse for given parameters.</span>

<span class="c1">#         Parameters:</span>
<span class="c1">#         - mean: array-like, shape (2,)</span>
<span class="c1">#             The mean of the data in the two dimensions being plotted.</span>
<span class="c1">#         - width: float</span>
<span class="c1">#             The width of the ellipse (related to variance along the major axis).</span>
<span class="c1">#         - height: float</span>
<span class="c1">#             The height of the ellipse (related to variance along the minor axis).</span>
<span class="c1">#         - angle: float</span>
<span class="c1">#             The rotation angle of the ellipse in degrees.</span>
<span class="c1">#         - ax: matplotlib.axes.Axes, optional</span>
<span class="c1">#             The axis on which to plot the ellipse. If None, creates a new figure.</span>
<span class="c1">#         - **kwargs: additional keyword arguments for matplotlib.patches.Ellipse.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         if ax is None:</span>
<span class="c1">#             fig, ax = plt.subplots()</span>

<span class="c1">#         # Add ellipse patch</span>
<span class="c1">#         ellipse = Ellipse(xy=mean, width=width, height=height, angle=angle, **kwargs)</span>
<span class="c1">#         ax.add_patch(ellipse)</span>
<span class="c1">#         ax.scatter(*mean, color=&#39;blue&#39;, label=&#39;Mean&#39;)</span>
        
<span class="c1">#         # Set axis labels</span>
<span class="c1">#         ax.set_xlabel(&quot;Principal Component 1 (Variance in Dim 1)&quot;)</span>
<span class="c1">#         ax.set_ylabel(&quot;Principal Component 2 (Variance in Dim 2)&quot;)</span>

<span class="c1">#         # Set title</span>
<span class="c1">#         ax.set_title(&quot;Confidence Ellipse (Width and Height Indicate Variance)&quot;)</span>
<span class="c1">#         ax.grid()</span>
<span class="c1">#         ax.legend()</span>
    
<span class="c1">#     def plot_top_relevant_CE_pairs(self, top_k=5, confidence_level=0.95):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Identify the top-k relevant pairs of dimensions (based on covariance magnitude)</span>
<span class="c1">#         and plot their confidence ellipses.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         mean = self.x_hat[self.active_indices]</span>
<span class="c1">#         cov = self.posterior_cov</span>

<span class="c1">#         n = len(mean)</span>
<span class="c1">#         pairs = list(combinations(range(n), 2))</span>
<span class="c1">#         pair_cov_magnitudes = [(pair, np.abs(cov[pair[0], pair[1]])) for pair in pairs]</span>
<span class="c1">#         sorted_pairs = sorted(pair_cov_magnitudes, key=lambda x: x[1], reverse=True)</span>
<span class="c1">#         top_pairs = [pair for pair, _ in sorted_pairs[:top_k]]</span>

<span class="c1">#         n_cols = min(3, top_k)</span>
<span class="c1">#         n_rows = (top_k + n_cols - 1) // n_cols</span>
<span class="c1">#         fig, axes = plt.subplots(n_rows, n_cols, figsize=(6 * n_cols, 6 * n_rows))</span>
<span class="c1">#         axes = axes.flatten()</span>

<span class="c1">#         for idx, (i, j) in enumerate(top_pairs):</span>
<span class="c1">#             mean_ij = mean[[i, j]]</span>
<span class="c1">#             cov_ij = cov[np.ix_([i, j], [i, j])]</span>

<span class="c1">#             width, height, angle = self._compute_confidence_ellipse(mean_ij, cov_ij, confidence_level)</span>
<span class="c1">#             self._plot_confidence_ellipse(mean_ij, width, height, angle, ax=axes[idx], edgecolor=&#39;blue&#39;, alpha=0.5)</span>

<span class="c1">#             axes[idx].set_title(f&quot;Dimensions {i} &amp; {j}&quot;)</span>

<span class="c1">#         for ax in axes[len(top_pairs):]:</span>
<span class="c1">#             fig.delaxes(ax)</span>

<span class="c1">#         fig.suptitle(&quot;Top Relevant Dimensional Pairs with Confidence Ellipses&quot;, fontsize=16)</span>
<span class="c1">#         plt.tight_layout(rect=[0, 0.05, 1, 0.96])</span>
<span class="c1">#         plt.savefig(os.path.join(self.experiment_dir, &#39;top_relevant_CE_pairs.png&#39;))</span>
<span class="c1">#         plt.close()</span>
        
<span class="c1">#     def plot_posterior_covariance_matrix(self):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Plot the posterior covariance matrix.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         if self.orientation_type == &#39;free&#39;:</span>
<span class="c1">#             # Check if posterior_cov shape is compatible with free orientation slicing</span>
<span class="c1">#             n_active_components = self.posterior_cov.shape[0]</span>
<span class="c1">#             if n_active_components % 3 != 0:</span>
<span class="c1">#                 self.logger.warning(f&quot;Free orientation: posterior_cov shape {self.posterior_cov.shape}, first dimension is not divisible by 3.&quot;)</span>
<span class="c1">#                 # Fallback to plotting the whole matrix if slicing is not possible</span>
<span class="c1">#                 fig, ax = plt.subplots(figsize=(10, 8))</span>
<span class="c1">#                 im = ax.imshow(self.posterior_cov, cmap=&#39;viridis&#39;, aspect=&#39;auto&#39;)</span>
<span class="c1">#                 fig.colorbar(im, ax=ax, label=&#39;Covariance Value&#39;)</span>
<span class="c1">#                 ax.set_title(&#39;Posterior Covariance Matrix (Free Orientation - Full)&#39;)</span>
<span class="c1">#                 ax.set_xlabel(&#39;Active Component Index&#39;)</span>
<span class="c1">#                 ax.set_ylabel(&#39;Active Component Index&#39;)</span>
<span class="c1">#                 plt.tight_layout(rect=[0, 0.05, 1, 0.96])</span>

<span class="c1">#             else:</span>
<span class="c1">#                 fig, axes = plt.subplots(3, 1, figsize=(10, 18))</span>
<span class="c1">#                 orientations = [&#39;X&#39;, &#39;Y&#39;, &#39;Z&#39;]</span>
<span class="c1">#                 # Determine shared color limits across the subplots</span>
<span class="c1">#                 vmin = np.min(self.posterior_cov)</span>
<span class="c1">#                 vmax = np.max(self.posterior_cov)</span>

<span class="c1">#                 images = [] # Store image objects for colorbar</span>
<span class="c1">#                 for i, ax in enumerate(axes):</span>
<span class="c1">#                     # Select the block corresponding to the orientation</span>
<span class="c1">#                     # This assumes active_indices components are ordered [src0_x, src0_y, src0_z, src1_x, ...]</span>
<span class="c1">#                     # which might not be true. A safer plot might show the full matrix.</span>
<span class="c1">#                     # Let&#39;s plot the diagonal blocks for now, assuming structure.</span>
<span class="c1">#                     try:</span>
<span class="c1">#                         cov_matrix_block = self.posterior_cov[i::3, i::3]</span>
<span class="c1">#                         im = ax.imshow(cov_matrix_block, cmap=&#39;viridis&#39;, aspect=&#39;auto&#39;, vmin=vmin, vmax=vmax)</span>
<span class="c1">#                         images.append(im)</span>
<span class="c1">#                         ax.set_title(f&#39;Diagonal Block - Orientation {orientations[i]}&#39;)</span>
<span class="c1">#                         ax.set_xlabel(&#39;Source Index (within orientation)&#39;)</span>
<span class="c1">#                         ax.set_ylabel(&#39;Source Index (within orientation)&#39;)</span>
<span class="c1">#                     except IndexError:</span>
<span class="c1">#                         self.logger.warning(f&quot;Could not extract block {i}::3 for orientation {orientations[i]}. Skipping subplot.&quot;)</span>
<span class="c1">#                         ax.set_title(f&#39;Orientation {orientations[i]} - Error&#39;)</span>

<span class="c1">#                 plt.tight_layout(rect=[0, 0.05, 1, 0.96])</span>

<span class="c1">#                 # Add colorbar spanning all axes, using the first image&#39;s mappable</span>
<span class="c1">#                 if images:</span>
<span class="c1">#                     fig.colorbar(images[0], ax=axes.ravel().tolist(), orientation=&#39;vertical&#39;, fraction=0.02, pad=0.04, label=&#39;Covariance Value&#39;)</span>


<span class="c1">#         else: # Fixed orientation</span>
<span class="c1">#             fig, ax = plt.subplots(figsize=(10, 8))</span>
<span class="c1">#             im = ax.imshow(self.posterior_cov, cmap=&#39;viridis&#39;, aspect=&#39;auto&#39;)</span>
<span class="c1">#             plt.colorbar(im, label=&#39;Covariance Value&#39;)</span>
<span class="c1">#             ax.set_title(&#39;Posterior Covariance Matrix (Fixed Orientation)&#39;)</span>
<span class="c1">#             ax.set_xlabel(&#39;Active Source Index&#39;)</span>
<span class="c1">#             ax.set_ylabel(&#39;Active Source Index&#39;)</span>
<span class="c1">#             plt.tight_layout(rect=[0, 0.05, 1, 0.96])</span>

<span class="c1">#         try:</span>
<span class="c1">#             plt.savefig(os.path.join(self.experiment_dir, &#39;posterior_covariance_matrix.png&#39;))</span>
<span class="c1">#             self.logger.info(f&quot;Posterior covariance matrix plot saved to {self.experiment_dir}/posterior_covariance_matrix.png&quot;)</span>
<span class="c1">#         except Exception as e:</span>
<span class="c1">#             self.logger.error(f&quot;Failed to save posterior covariance matrix plot: {e}&quot;)</span>
<span class="c1">#         finally:</span>
<span class="c1">#             plt.close(fig) </span>
    
<span class="c1">#     def visualize_sorted_covariances(self, top_k=None):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         Visualize the sorted magnitudes of covariances for all pairs of dimensions.</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         sorted_pairs = self._compute_top_covariance_pairs(self.posterior_cov, top_k=top_k)</span>
<span class="c1">#         pairs = [f&quot;({i},{j})&quot; for (i, j), _ in sorted_pairs]</span>
<span class="c1">#         magnitudes = [magnitude for _, magnitude in sorted_pairs]</span>

<span class="c1">#         plt.figure(figsize=(10, 6))</span>
<span class="c1">#         plt.bar(pairs, magnitudes, color=&#39;skyblue&#39;)</span>
<span class="c1">#         plt.xlabel(&#39;Pairs of Dimensions&#39;)</span>
<span class="c1">#         plt.ylabel(&#39;Covariance Magnitude&#39;)</span>
<span class="c1">#         plt.title(f&quot;Top-{top_k if top_k else len(magnitudes)} Sorted Covariance Magnitudes&quot;)</span>
<span class="c1">#         plt.xticks(rotation=45, ha=&#39;right&#39;)</span>
<span class="c1">#         plt.tight_layout(rect=[0, 0.05, 1, 0.96])</span>
<span class="c1">#         plt.savefig(os.path.join(self.experiment_dir, &#39;sorted_covariances.png&#39;))</span>
<span class="c1">#         plt.close()</span>


<span class="c1"># ============================================================================</span>

<span class="c1"># def visualize_leadfield(</span>
<span class="c1">#     self,</span>
<span class="c1">#     leadfield_matrix: np.ndarray,</span>
<span class="c1">#     orientation_type: str = &quot;fixed&quot;,</span>
<span class="c1">#     save_path: Optional[str] = None,</span>
<span class="c1">#     show: bool = False</span>
<span class="c1"># ) -&gt; None:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Visualize the leadfield matrix as a heatmap.</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     leadfield_matrix : np.ndarray</span>
<span class="c1">#         The leadfield matrix.</span>
<span class="c1">#         - &#39;fixed&#39;: Shape (n_sensors, n_sources).</span>
<span class="c1">#         - &#39;free&#39;: Shape (n_sensors, n_sources, 3).</span>
<span class="c1">#     orientation_type : str, optional</span>
<span class="c1">#         Orientation type (&#39;fixed&#39; or &#39;free&#39;), by default &quot;fixed&quot;.</span>
<span class="c1">#     save_path : Optional[str], optional</span>
<span class="c1">#         Path to save the figure. If None, not saved, by default None.</span>
<span class="c1">#     show : bool, optional</span>
<span class="c1">#         If True, display the plot, by default False.</span>

<span class="c1">#     Raises</span>
<span class="c1">#     ------</span>
<span class="c1">#     ValueError</span>
<span class="c1">#         If leadfield_matrix is invalid or orientation_type is unsupported.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     if leadfield_matrix is None or not isinstance(leadfield_matrix, np.ndarray) or leadfield_matrix.size == 0:</span>
<span class="c1">#         self.logger.error(&quot;Invalid leadfield matrix provided for visualization.&quot;)</span>
<span class="c1">#         return</span>

<span class="c1">#     fig = None # Initialize fig</span>
<span class="c1">#     try:</span>
<span class="c1">#         if orientation_type == &quot;fixed&quot;:</span>
<span class="c1">#             if leadfield_matrix.ndim != 2:</span>
<span class="c1">#                  raise ValueError(f&quot;Expected 2D leadfield for fixed orientation, got {leadfield_matrix.ndim}D&quot;)</span>
<span class="c1">#             fig, ax = plt.subplots(figsize=(10, 8))</span>
<span class="c1">#             im = ax.imshow(leadfield_matrix, aspect=&#39;auto&#39;, cmap=&#39;viridis&#39;, interpolation=&#39;nearest&#39;)</span>
<span class="c1">#             fig.colorbar(im, ax=ax, label=&quot;Amplitude (ÂµV / nAm)&quot;, fraction=0.05, pad=0.04)</span>
<span class="c1">#             ax.set_title(&quot;Leadfield Matrix (Fixed Orientation)&quot;)</span>
<span class="c1">#             ax.set_xlabel(&quot;Sources&quot;)</span>
<span class="c1">#             ax.set_ylabel(&quot;Sensors&quot;)</span>
<span class="c1">#         elif orientation_type == &quot;free&quot;:</span>
<span class="c1">#             if leadfield_matrix.ndim != 3 or leadfield_matrix.shape[-1] != 3:</span>
<span class="c1">#                  raise ValueError(f&quot;Expected 3D leadfield (..., 3) for free orientation, got shape {leadfield_matrix.shape}&quot;)</span>
<span class="c1">#             n_orient = leadfield_matrix.shape[-1]</span>
<span class="c1">#             fig, axes = plt.subplots(1, n_orient, figsize=(15, 5), sharey=True)</span>
<span class="c1">#             if n_orient == 1: axes = [axes] # Ensure axes is iterable</span>
<span class="c1">#             orientations = [&quot;X&quot;, &quot;Y&quot;, &quot;Z&quot;]</span>
<span class="c1">#             images = []</span>
<span class="c1">#             for i in range(n_orient):</span>
<span class="c1">#                 im = axes[i].imshow(leadfield_matrix[:, :, i], aspect=&#39;auto&#39;, cmap=&#39;viridis&#39;, interpolation=&#39;nearest&#39;)</span>
<span class="c1">#                 images.append(im)</span>
<span class="c1">#                 axes[i].set_title(f&quot;Leadfield Matrix ({orientations[i]})&quot;)</span>
<span class="c1">#                 axes[i].set_xlabel(&quot;Sources&quot;)</span>
<span class="c1">#             axes[0].set_ylabel(&quot;Sensors&quot;)</span>
<span class="c1">#             fig.colorbar(images[0], ax=axes, location=&quot;right&quot;, label=&quot;Amplitude (ÂµV / nAm)&quot;, fraction=0.05, pad=0.04)</span>
<span class="c1">#         else:</span>
<span class="c1">#             raise ValueError(&quot;Invalid orientation type. Must be &#39;fixed&#39; or &#39;free&#39;.&quot;)</span>

<span class="c1">#         plt.tight_layout()</span>

<span class="c1">#         if save_path:</span>
<span class="c1">#             save_dir = Path(save_path).parent</span>
<span class="c1">#             save_dir.mkdir(parents=True, exist_ok=True)</span>
<span class="c1">#             plt.savefig(save_path, bbox_inches=&quot;tight&quot;)</span>
<span class="c1">#             self.logger.info(f&quot;Leadfield matrix visualization saved to {save_path}&quot;)</span>
<span class="c1">#         if show:</span>
<span class="c1">#             plt.show()</span>

<span class="c1">#     except Exception as e:</span>
<span class="c1">#          self.logger.error(f&quot;Failed during leadfield visualization: {e}&quot;)</span>
<span class="c1">#     finally:</span>
<span class="c1">#          if fig:</span>
<span class="c1">#              plt.close(fig)</span>

<span class="c1"># def visualize_leadfield_distribution(</span>
<span class="c1">#     self,</span>
<span class="c1">#     leadfield_matrix: np.ndarray,</span>
<span class="c1">#     orientation_type: str = &quot;fixed&quot;,</span>
<span class="c1">#     bins: int = 100,</span>
<span class="c1">#     save_path: Optional[str] = None,</span>
<span class="c1">#     title: Optional[str] = None,</span>
<span class="c1">#     show: bool = False</span>
<span class="c1"># ) -&gt; None:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Visualize the distribution of leadfield amplitude values using a histogram.</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     leadfield_matrix : np.ndarray</span>
<span class="c1">#         The leadfield matrix.</span>
<span class="c1">#         - &#39;fixed&#39;: Shape (n_sensors, n_sources).</span>
<span class="c1">#         - &#39;free&#39;: Shape (n_sensors, n_sources, 3).</span>
<span class="c1">#     orientation_type : str, optional</span>
<span class="c1">#         Orientation type (&#39;fixed&#39; or &#39;free&#39;), by default &quot;fixed&quot;.</span>
<span class="c1">#         This mainly affects the title and interpretation.</span>
<span class="c1">#     bins : int, optional</span>
<span class="c1">#         Number of bins for the histogram, by default 100.</span>
<span class="c1">#     save_path : Optional[str], optional</span>
<span class="c1">#         Path to save the figure. If None, not saved, by default None.</span>
<span class="c1">#     title : Optional[str], optional</span>
<span class="c1">#         Custom title for the plot. If None, a default title is generated.</span>
<span class="c1">#     show : bool, optional</span>
<span class="c1">#         If True, display the plot, by default False.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     if leadfield_matrix is None or not isinstance(leadfield_matrix, np.ndarray) or leadfield_matrix.size == 0:</span>
<span class="c1">#         self.logger.error(&quot;Invalid leadfield matrix provided for distribution visualization.&quot;)</span>
<span class="c1">#         return</span>

<span class="c1">#     fig = None # Initialize fig</span>
<span class="c1">#     try:</span>
<span class="c1">#         fig, ax = plt.subplots(figsize=(10, 6))</span>

<span class="c1">#         # Flatten the leadfield matrix to get all values for the histogram</span>
<span class="c1">#         # For &#39;free&#39; orientation, this will include values from all X, Y, Z components.</span>
<span class="c1">#         leadfield_values_flat = leadfield_matrix.flatten()</span>

<span class="c1">#         ax.hist(leadfield_values_flat, bins=bins, color=&#39;skyblue&#39;, edgecolor=&#39;black&#39;, alpha=0.7)</span>

<span class="c1">#         if title is None:</span>
<span class="c1">#             default_title = f&quot;Distribution of Leadfield Amplitudes ({orientation_type.capitalize()} Orientation)&quot;</span>
<span class="c1">#             ax.set_title(default_title, fontsize=14)</span>
<span class="c1">#         else:</span>
<span class="c1">#             ax.set_title(title, fontsize=14)</span>

<span class="c1">#         ax.set_xlabel(&quot;Leadfield Amplitude (ÂµV / nAm)&quot;, fontsize=12)</span>
<span class="c1">#         ax.set_ylabel(&quot;Frequency&quot;, fontsize=12)</span>
<span class="c1">#         ax.grid(True, linestyle=&#39;--&#39;, alpha=0.7)</span>

<span class="c1">#         # Add some statistics to the plot</span>
<span class="c1">#         mean_val = np.mean(leadfield_values_flat)</span>
<span class="c1">#         std_val = np.std(leadfield_values_flat)</span>
<span class="c1">#         median_val = np.median(leadfield_values_flat)</span>
<span class="c1">#         min_val = np.min(leadfield_values_flat)</span>
<span class="c1">#         max_val = np.max(leadfield_values_flat)</span>

<span class="c1">#         stats_text = (</span>
<span class="c1">#             f&quot;Mean: {mean_val:.2e}\nStd: {std_val:.2e}\nMedian: {median_val:.2e}\n&quot;</span>
<span class="c1">#             f&quot;Min: {min_val:.2e}\nMax: {max_val:.2e}\nN Values: {len(leadfield_values_flat)}&quot;</span>
<span class="c1">#         )</span>
<span class="c1">#         # Position the text box in the upper right corner</span>
<span class="c1">#         ax.text(0.95, 0.95, stats_text, transform=ax.transAxes, fontsize=9,</span>
<span class="c1">#                 verticalalignment=&#39;top&#39;, horizontalalignment=&#39;right&#39;,</span>
<span class="c1">#                 bbox=dict(boxstyle=&#39;round,pad=0.5&#39;, fc=&#39;wheat&#39;, alpha=0.5))</span>


<span class="c1">#         plt.tight_layout()</span>

<span class="c1">#         if save_path:</span>
<span class="c1">#             save_dir = Path(save_path).parent</span>
<span class="c1">#             save_dir.mkdir(parents=True, exist_ok=True)</span>
<span class="c1">#             plt.savefig(save_path, bbox_inches=&quot;tight&quot;)</span>
<span class="c1">#             self.logger.info(f&quot;Leadfield distribution visualization saved to {save_path}&quot;)</span>
<span class="c1">#         if show:</span>
<span class="c1">#             plt.show()</span>

<span class="c1">#     except Exception as e:</span>
<span class="c1">#          self.logger.error(f&quot;Failed during leadfield distribution visualization: {e}&quot;)</span>
<span class="c1">#     finally:</span>
<span class="c1">#          if fig:</span>
<span class="c1">#              plt.close(fig)</span>



<span class="c1"># def visualize_leadfield_summary(</span>
<span class="c1">#     self,</span>
<span class="c1">#     leadfield_matrix: np.ndarray,</span>
<span class="c1">#     orientation_type: str = &quot;fixed&quot;,</span>
<span class="c1">#     bins: int = 100,</span>
<span class="c1">#     sensor_indices_to_plot: Optional[List[int]] = None,</span>
<span class="c1">#     max_sensors_to_plot: int = 10,</span>
<span class="c1">#     main_title: Optional[str] = None,</span>
<span class="c1">#     save_path: Optional[str] = None,</span>
<span class="c1">#     show: bool = False</span>
<span class="c1"># ) -&gt; None:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Visualize a summary of the leadfield matrix in a single figure:</span>
<span class="c1">#     1. Top: Heatmap of the leadfield (norm for &#39;free&#39; orientation).</span>
<span class="c1">#     2. Bottom-Left: Box plots of leadfield amplitudes for selected sensors.</span>
<span class="c1">#     3. Bottom-Right: Rotated histogram of all leadfield amplitudes (marginal to boxplots).</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     leadfield_matrix : np.ndarray</span>
<span class="c1">#         The leadfield matrix.</span>
<span class="c1">#         - &#39;fixed&#39;: Shape (n_sensors, n_sources).</span>
<span class="c1">#         - &#39;free&#39;: Shape (n_sensors, n_sources, 3).</span>
<span class="c1">#     orientation_type : str, optional</span>
<span class="c1">#         Orientation type (&#39;fixed&#39; or &#39;free&#39;), by default &quot;fixed&quot;.</span>
<span class="c1">#     bins : int, optional</span>
<span class="c1">#         Number of bins for the histogram subplot, by default 100.</span>
<span class="c1">#     sensor_indices_to_plot : Optional[List[int]], optional</span>
<span class="c1">#         Specific list of sensor indices for the box plot. If None, a subset is chosen.</span>
<span class="c1">#     max_sensors_to_plot : int, optional</span>
<span class="c1">#         Maximum number of sensors for the box plot if sensor_indices_to_plot is None.</span>
<span class="c1">#     main_title : Optional[str], optional</span>
<span class="c1">#         Overall title for the figure.</span>
<span class="c1">#     save_path : Optional[str], optional</span>
<span class="c1">#         Path to save the figure.</span>
<span class="c1">#     show : bool, optional</span>
<span class="c1">#         If True, display the plot.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     if leadfield_matrix is None or not isinstance(leadfield_matrix, np.ndarray) or leadfield_matrix.size == 0:</span>
<span class="c1">#         self.logger.error(&quot;Invalid leadfield matrix provided for summary visualization.&quot;)</span>
<span class="c1">#         return</span>

<span class="c1">#     fig = None</span>
<span class="c1">#     try:</span>
<span class="c1">#         # Define the layout using GridSpec</span>
<span class="c1">#         # Figure will have 2 main rows. The second row is split into 2 columns.</span>
<span class="c1">#         # Heatmap takes more vertical space.</span>
<span class="c1">#         fig = plt.figure(figsize=(15, 18)) # Adjusted figsize</span>
<span class="c1">#         gs = gridspec.GridSpec(2, 2, height_ratios=[1.2, 1], width_ratios=[3, 1])</span>

<span class="c1">#         ax_heatmap = fig.add_subplot(gs[0, :])  # Heatmap spans both columns of the first row</span>
<span class="c1">#         ax_boxplot = fig.add_subplot(gs[1, 0])  # Boxplot in the second row, first column</span>
<span class="c1">#         ax_hist_y = fig.add_subplot(gs[1, 1], sharey=ax_boxplot) # Rotated histogram, shares y-axis with boxplot</span>

<span class="c1">#         if main_title is None:</span>
<span class="c1">#             default_main_title = f&quot;Leadfield Matrix Summary ({orientation_type.capitalize()} Orientation)&quot;</span>
<span class="c1">#             fig.suptitle(default_main_title, fontsize=18, y=0.99)</span>
<span class="c1">#         elif main_title:</span>
<span class="c1">#             fig.suptitle(main_title, fontsize=18, y=0.99)</span>

<span class="c1">#         # --- Subplot 1: Leadfield Heatmap (ax_heatmap) ---</span>
<span class="c1">#         if orientation_type == &quot;fixed&quot;:</span>
<span class="c1">#             if leadfield_matrix.ndim != 2:</span>
<span class="c1">#                 raise ValueError(f&quot;Heatmap: Expected 2D leadfield for fixed, got {leadfield_matrix.ndim}D&quot;)</span>
<span class="c1">#             lf_to_plot = leadfield_matrix</span>
<span class="c1">#             heatmap_title = &quot;Leadfield Matrix (Fixed Orientation)&quot;</span>
<span class="c1">#         elif orientation_type == &quot;free&quot;:</span>
<span class="c1">#             if leadfield_matrix.ndim != 3 or leadfield_matrix.shape[-1] != 3:</span>
<span class="c1">#                 raise ValueError(f&quot;Heatmap: Expected 3D leadfield (..., 3) for free, got {leadfield_matrix.shape}&quot;)</span>
<span class="c1">#             lf_to_plot = np.linalg.norm(leadfield_matrix, axis=-1)</span>
<span class="c1">#             heatmap_title = &quot;Leadfield Matrix (Free Orientation - Norm)&quot;</span>
<span class="c1">#         else:</span>
<span class="c1">#             raise ValueError(&quot;Heatmap: Invalid orientation type.&quot;)</span>
        
<span class="c1">#         im = ax_heatmap.imshow(lf_to_plot, aspect=&#39;auto&#39;, cmap=&#39;viridis&#39;, interpolation=&#39;nearest&#39;)</span>
<span class="c1">#         # Add colorbar to the heatmap subplot</span>
<span class="c1">#         cbar = fig.colorbar(im, ax=ax_heatmap, label=&quot;Amplitude (ÂµV / nAm)&quot;, fraction=0.046, pad=0.04, orientation=&#39;vertical&#39;)</span>
<span class="c1">#         ax_heatmap.set_title(heatmap_title, fontsize=14)</span>
<span class="c1">#         ax_heatmap.set_xlabel(&quot;Sources&quot;, fontsize=12)</span>
<span class="c1">#         ax_heatmap.set_ylabel(&quot;Sensors&quot;, fontsize=12)</span>

<span class="c1">#         # --- Data for Histogram and Boxplot ---</span>
<span class="c1">#         leadfield_values_flat = leadfield_matrix.flatten() # For overall distribution</span>
<span class="c1">#         num_total_sensors = leadfield_matrix.shape[0]</span>
<span class="c1">#         actual_sensor_indices_to_plot: np.ndarray</span>

<span class="c1">#         if sensor_indices_to_plot is None:</span>
<span class="c1">#             if num_total_sensors &gt; max_sensors_to_plot:</span>
<span class="c1">#                 actual_sensor_indices_to_plot = np.linspace(0, num_total_sensors - 1, max_sensors_to_plot, dtype=int)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 actual_sensor_indices_to_plot = np.arange(num_total_sensors)</span>
<span class="c1">#         else:</span>
<span class="c1">#             actual_sensor_indices_to_plot = np.array(sensor_indices_to_plot, dtype=int)</span>
<span class="c1">#             if np.any(actual_sensor_indices_to_plot &lt; 0) or np.any(actual_sensor_indices_to_plot &gt;= num_total_sensors):</span>
<span class="c1">#                 self.logger.error(&quot;Boxplot: Invalid sensor_indices_to_plot.&quot;)</span>
<span class="c1">#                 ax_boxplot.text(0.5, 0.5, &quot;Error: Invalid sensor indices.&quot;, ha=&#39;center&#39;, va=&#39;center&#39;, color=&#39;red&#39;)</span>
<span class="c1">#                 actual_sensor_indices_to_plot = np.array([])</span>

<span class="c1">#         # --- Subplot 2: Leadfield Sensor Box Plots (ax_boxplot) ---</span>
<span class="c1">#         if len(actual_sensor_indices_to_plot) &gt; 0:</span>
<span class="c1">#             data_for_boxplot = []</span>
<span class="c1">#             labels_for_boxplot = []</span>
<span class="c1">#             for sensor_idx in actual_sensor_indices_to_plot:</span>
<span class="c1">#                 if orientation_type == &quot;fixed&quot;:</span>
<span class="c1">#                     sensor_values = leadfield_matrix[sensor_idx, :]</span>
<span class="c1">#                 elif orientation_type == &quot;free&quot;:</span>
<span class="c1">#                     sensor_values_3d = leadfield_matrix[sensor_idx, :, :]</span>
<span class="c1">#                     sensor_values = np.linalg.norm(sensor_values_3d, axis=-1)</span>
<span class="c1">#                 else:</span>
<span class="c1">#                     raise ValueError(&quot;Boxplot: Invalid orientation type.&quot;)</span>
<span class="c1">#                 data_for_boxplot.append(sensor_values)</span>
<span class="c1">#                 labels_for_boxplot.append(str(sensor_idx))</span>
            
<span class="c1">#             bp = ax_boxplot.boxplot(data_for_boxplot, patch_artist=True, medianprops=dict(color=&quot;black&quot;, linewidth=1.5), vert=True)</span>
<span class="c1">#             try:</span>
<span class="c1">#                 colors_list = cm.get_cmap(&#39;viridis&#39;, len(data_for_boxplot))</span>
<span class="c1">#                 for i, patch in enumerate(bp[&#39;boxes&#39;]):</span>
<span class="c1">#                     patch.set_facecolor(colors_list(i / len(data_for_boxplot)))</span>
<span class="c1">#             except AttributeError:</span>
<span class="c1">#                  self.logger.warning(&quot;Boxplot: Could not apply distinct colors.&quot;)</span>
            
<span class="c1">#             ax_boxplot.set_title(&quot;Leadfield Amplitude per Sensor&quot;, fontsize=14)</span>
<span class="c1">#             ax_boxplot.set_xlabel(&quot;Sensor Index&quot;, fontsize=12)</span>
<span class="c1">#             ax_boxplot.set_ylabel(&quot;Leadfield Amplitude (ÂµV / nAm)&quot;, fontsize=12)</span>
<span class="c1">#             ax_boxplot.set_xticklabels(labels_for_boxplot, rotation=45, ha=&quot;right&quot; if len(labels_for_boxplot) &gt; 5 else &quot;center&quot;)</span>
<span class="c1">#             ax_boxplot.grid(True, linestyle=&#39;--&#39;, alpha=0.6, axis=&#39;y&#39;)</span>
<span class="c1">#         elif not (np.any(actual_sensor_indices_to_plot &lt; 0) or np.any(actual_sensor_indices_to_plot &gt;= num_total_sensors)):</span>
<span class="c1">#             ax_boxplot.text(0.5, 0.5, &quot;No sensors for boxplot.&quot;, ha=&#39;center&#39;, va=&#39;center&#39;)</span>
<span class="c1">#             ax_boxplot.set_xlabel(&quot;Sensor Index&quot;, fontsize=12)</span>
<span class="c1">#             ax_boxplot.set_ylabel(&quot;Leadfield Amplitude (ÂµV / nAm)&quot;, fontsize=12)</span>


<span class="c1">#         # --- Subplot 3: Rotated Histogram (ax_hist_y) ---</span>
<span class="c1">#         # This histogram shows the distribution of ALL leadfield values</span>
<span class="c1">#         ax_hist_y.hist(leadfield_values_flat, bins=bins, color=&#39;skyblue&#39;, edgecolor=&#39;black&#39;, alpha=0.7, orientation=&#39;horizontal&#39;)</span>
<span class="c1">#         ax_hist_y.set_title(&quot;Overall Distribution&quot;, fontsize=14)</span>
<span class="c1">#         ax_hist_y.set_xlabel(&quot;Frequency&quot;, fontsize=12)</span>
<span class="c1">#         # Remove y-tick labels for the histogram as it shares y-axis with boxplot</span>
<span class="c1">#         plt.setp(ax_hist_y.get_yticklabels(), visible=False)</span>
<span class="c1">#         ax_hist_y.grid(True, linestyle=&#39;--&#39;, alpha=0.7, axis=&#39;x&#39;)</span>

<span class="c1">#         mean_val = np.mean(leadfield_values_flat)</span>
<span class="c1">#         std_val = np.std(leadfield_values_flat)</span>
<span class="c1">#         median_val = np.median(leadfield_values_flat)</span>
<span class="c1">#         stats_text = (</span>
<span class="c1">#             f&quot;Mean: {mean_val:.2e}\nStd: {std_val:.2e}\nMedian: {median_val:.2e}&quot;</span>
<span class="c1">#         )</span>
<span class="c1">#         # Add stats text to the histogram plot, adjusting position for horizontal orientation</span>
<span class="c1">#         ax_hist_y.text(0.95, 0.95, stats_text, transform=ax_hist_y.transAxes, fontsize=9,</span>
<span class="c1">#                        verticalalignment=&#39;top&#39;, horizontalalignment=&#39;right&#39;,</span>
<span class="c1">#                        bbox=dict(boxstyle=&#39;round,pad=0.3&#39;, fc=&#39;wheat&#39;, alpha=0.5))</span>


<span class="c1">#         # Adjust layout</span>
<span class="c1">#         gs.tight_layout(fig, rect=[0, 0, 1, 0.96] if main_title else [0,0,1,1]) # Use GridSpec&#39;s tight_layout</span>

<span class="c1">#         if save_path:</span>
<span class="c1">#             save_dir = Path(save_path).parent</span>
<span class="c1">#             save_dir.mkdir(parents=True, exist_ok=True)</span>
<span class="c1">#             plt.savefig(save_path, bbox_inches=&quot;tight&quot;, dpi=150) # Added dpi</span>
<span class="c1">#             self.logger.info(f&quot;Leadfield summary visualization saved to {save_path}&quot;)</span>
<span class="c1">#         if show:</span>
<span class="c1">#             plt.show()</span>

<span class="c1">#     except Exception as e:</span>
<span class="c1">#          self.logger.error(f&quot;Failed during leadfield summary visualization: {e}&quot;, exc_info=True) # Added exc_info</span>
<span class="c1">#     finally:</span>
<span class="c1">#          if fig:</span>
<span class="c1">#              plt.close(fig)</span>


<span class="c1"># def visualize_leadfield_sensor_boxplot(</span>
<span class="c1">#     self,</span>
<span class="c1">#     leadfield_matrix: np.ndarray,</span>
<span class="c1">#     orientation_type: str = &quot;fixed&quot;,</span>
<span class="c1">#     sensor_indices_to_plot: Optional[List[int]] = None,</span>
<span class="c1">#     max_sensors_to_plot: int = 20,</span>
<span class="c1">#     save_path: Optional[str] = None,</span>
<span class="c1">#     custom_title: Optional[str] = None,</span>
<span class="c1">#     show: bool = False</span>
<span class="c1"># ) -&gt; None:</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Visualize the distribution of leadfield amplitudes for selected sensors using box plots.</span>
<span class="c1">#     Each box plot represents one sensor, showing the distribution of its leadfield</span>
<span class="c1">#     values across all sources. For &#39;free&#39; orientation, the norm of the 3 components</span>
<span class="c1">#     is used for each source-sensor pair.</span>

<span class="c1">#     Parameters</span>
<span class="c1">#     ----------</span>
<span class="c1">#     leadfield_matrix : np.ndarray</span>
<span class="c1">#         The leadfield matrix.</span>
<span class="c1">#         - &#39;fixed&#39;: Shape (n_sensors, n_sources).</span>
<span class="c1">#         - &#39;free&#39;: Shape (n_sensors, n_sources, 3).</span>
<span class="c1">#     orientation_type : str, optional</span>
<span class="c1">#         Orientation type (&#39;fixed&#39; or &#39;free&#39;), by default &quot;fixed&quot;.</span>
<span class="c1">#     sensor_indices_to_plot : Optional[List[int]], optional</span>
<span class="c1">#         Specific list of sensor indices to plot. If None, a subset is chosen</span>
<span class="c1">#         based on max_sensors_to_plot, by default None.</span>
<span class="c1">#     max_sensors_to_plot : int, optional</span>
<span class="c1">#         Maximum number of sensors to create box plots for if sensor_indices_to_plot</span>
<span class="c1">#         is None, by default 20.</span>
<span class="c1">#     save_path : Optional[str], optional</span>
<span class="c1">#         Path to save the figure. If None, not saved, by default None.</span>
<span class="c1">#     custom_title : Optional[str], optional</span>
<span class="c1">#         Custom title for the plot. If None, a default title is generated.</span>
<span class="c1">#     show : bool, optional</span>
<span class="c1">#         If True, display the plot, by default False.</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     if leadfield_matrix is None or not isinstance(leadfield_matrix, np.ndarray) or leadfield_matrix.size == 0:</span>
<span class="c1">#         self.logger.error(&quot;Invalid leadfield matrix provided for box plot visualization.&quot;)</span>
<span class="c1">#         return</span>

<span class="c1">#     fig = None # Initialize fig</span>
<span class="c1">#     try:</span>
<span class="c1">#         num_total_sensors = leadfield_matrix.shape[0]</span>

<span class="c1">#         if sensor_indices_to_plot is None:</span>
<span class="c1">#             if num_total_sensors &gt; max_sensors_to_plot:</span>
<span class="c1">#                 # Select evenly spaced sensors</span>
<span class="c1">#                 selected_indices = np.linspace(0, num_total_sensors - 1, max_sensors_to_plot, dtype=int)</span>
<span class="c1">#                 self.logger.info(f&quot;Plotting box plots for {max_sensors_to_plot} selected sensors out of {num_total_sensors}.&quot;)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 selected_indices = np.arange(num_total_sensors)</span>
<span class="c1">#         else:</span>
<span class="c1">#             selected_indices = np.array(sensor_indices_to_plot, dtype=int)</span>
<span class="c1">#             if np.any(selected_indices &lt; 0) or np.any(selected_indices &gt;= num_total_sensors):</span>
<span class="c1">#                 self.logger.error(&quot;Invalid sensor_indices_to_plot: indices out of bounds.&quot;)</span>
<span class="c1">#                 return</span>
        
<span class="c1">#         if len(selected_indices) == 0:</span>
<span class="c1">#             self.logger.info(&quot;No sensors selected for box plot visualization.&quot;)</span>
<span class="c1">#             return</span>

<span class="c1">#         data_for_boxplot = []</span>
<span class="c1">#         labels_for_boxplot = []</span>

<span class="c1">#         for sensor_idx in selected_indices:</span>
<span class="c1">#             if orientation_type == &quot;fixed&quot;:</span>
<span class="c1">#                 if leadfield_matrix.ndim != 2:</span>
<span class="c1">#                     raise ValueError(f&quot;Expected 2D leadfield for fixed orientation, got {leadfield_matrix.ndim}D shape {leadfield_matrix.shape}&quot;)</span>
<span class="c1">#                 sensor_values = leadfield_matrix[sensor_idx, :]</span>
<span class="c1">#             elif orientation_type == &quot;free&quot;:</span>
<span class="c1">#                 if leadfield_matrix.ndim != 3 or leadfield_matrix.shape[-1] != 3:</span>
<span class="c1">#                     raise ValueError(f&quot;Expected 3D leadfield (..., 3) for free orientation, got shape {leadfield_matrix.shape}&quot;)</span>
<span class="c1">#                 sensor_values_3d = leadfield_matrix[sensor_idx, :, :] # Shape (n_sources, 3)</span>
<span class="c1">#                 sensor_values = np.linalg.norm(sensor_values_3d, axis=-1) # Shape (n_sources,)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 raise ValueError(f&quot;Invalid orientation_type &#39;{orientation_type}&#39;. Choose &#39;fixed&#39; or &#39;free&#39;.&quot;)</span>
            
<span class="c1">#             data_for_boxplot.append(sensor_values)</span>
<span class="c1">#             labels_for_boxplot.append(str(sensor_idx))</span>

<span class="c1">#         # Adjust figure width based on the number of boxplots, with a max width</span>
<span class="c1">#         fig_width = min(max(10, len(selected_indices) * 0.7), 25)</span>
<span class="c1">#         fig, ax = plt.subplots(figsize=(fig_width, 7))</span>
        
<span class="c1">#         bp = ax.boxplot(data_for_boxplot, patch_artist=True, medianprops=dict(color=&quot;black&quot;, linewidth=1.5))</span>

<span class="c1">#         # Optional: Color the boxes using a colormap</span>
<span class="c1">#         # Ensure you have `import matplotlib.cm as cm`</span>
<span class="c1">#         try:</span>
<span class="c1">#             colors_list = cm.get_cmap(&#39;viridis&#39;, len(data_for_boxplot))</span>
<span class="c1">#             for i, patch in enumerate(bp[&#39;boxes&#39;]):</span>
<span class="c1">#                 patch.set_facecolor(colors_list(i / len(data_for_boxplot))) # Normalize index for colormap</span>
<span class="c1">#         except AttributeError: # Fallback if get_cmap with number of colors is not supported (older matplotlib)</span>
<span class="c1">#              self.logger.warning(&quot;Could not apply distinct colors to boxplots; using default or single color.&quot;)</span>


<span class="c1">#         if custom_title is None:</span>
<span class="c1">#             default_title = f&quot;Leadfield Amplitude Distribution per Sensor ({orientation_type.capitalize()} Orientation)&quot;</span>
<span class="c1">#             ax.set_title(default_title, fontsize=14, pad=15)</span>
<span class="c1">#         else:</span>
<span class="c1">#             ax.set_title(custom_title, fontsize=14, pad=15)</span>

<span class="c1">#         ax.set_xlabel(&quot;Sensor Index&quot;, fontsize=12)</span>
<span class="c1">#         ax.set_ylabel(&quot;Leadfield Amplitude (ÂµV / nAm)&quot;, fontsize=12)</span>
<span class="c1">#         ax.set_xticklabels(labels_for_boxplot, rotation=45, ha=&quot;right&quot; if len(labels_for_boxplot) &gt; 10 else &quot;center&quot;)</span>
<span class="c1">#         ax.grid(True, linestyle=&#39;--&#39;, alpha=0.6, axis=&#39;y&#39;)</span>

<span class="c1">#         plt.tight_layout()</span>

<span class="c1">#         if save_path:</span>
<span class="c1">#             save_dir = Path(save_path).parent</span>
<span class="c1">#             save_dir.mkdir(parents=True, exist_ok=True)</span>
<span class="c1">#             plt.savefig(save_path, bbox_inches=&quot;tight&quot;)</span>
<span class="c1">#             self.logger.info(f&quot;Leadfield sensor box plot visualization saved to {save_path}&quot;)</span>
<span class="c1">#         if show:</span>
<span class="c1">#             plt.show()</span>

<span class="c1">#     except Exception as e:</span>
<span class="c1">#          self.logger.error(f&quot;Failed during leadfield sensor box plot visualization: {e}&quot;)</span>
<span class="c1">#     finally:</span>
<span class="c1">#          if fig:</span>
<span class="c1">#              plt.close(fig)</span>
        
        
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      Â© Copyright 2025, Mohammad Orabe, Ismail Huseynov.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>